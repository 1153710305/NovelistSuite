# ä¸Šä¸‹æ–‡æ¸…æ´— (Context Scrubbing) ä¼˜åŒ–æ€»ç»“

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆ: "é‡æ–°ç”Ÿæˆå¯¼å›¾æ—¶ï¼Œå¯ç”¨AIæ¸…æ´—åæ˜æ˜æœ‰å†…å®¹ï¼Œå‹ç¼©ç‡å´ä¸º0%"ã€‚

**åˆ†æ**:
1. å‹ç¼©ç‡ä¸º 0% æ„å‘³ç€æ¸…æ´—åçš„æ–‡æœ¬é•¿åº¦ä¸åŸæ–‡å‡ ä¹ä¸€è‡´ã€‚
2. åœ¨ä»£ç é€»è¾‘ä¸­ï¼Œå½“æ¸…æ´—è¿‡ç¨‹å‘ç”Ÿé”™è¯¯ï¼ˆå¦‚ API å¤±è´¥ã€JSON è§£æå¤±è´¥ï¼‰æˆ–æ¸…æ´—ç»“æœä¸ºç©ºæ—¶ï¼Œä¸ºäº†é˜²æ­¢æ•°æ®ä¸¢å¤±ï¼Œä¼šå¼ºåˆ¶è¿”å›**åŸå§‹æ–‡æœ¬** (Raw Context)ã€‚
3. å› æ­¤ï¼Œç”¨æˆ·çœ‹åˆ°çš„ 0% å®é™…ä¸Šæ˜¯**æ¸…æ´—å¤±è´¥**çš„æ ‡å¿—ã€‚

## ğŸ› ï¸ ä¿®å¤ä¸ä¼˜åŒ–

é’ˆå¯¹æ­¤é—®é¢˜ï¼Œæˆ‘ä»¬å¯¹ `services/geminiService.ts` ä¸­çš„ `optimizeContextWithAI` å‡½æ•°è¿›è¡Œäº†ä»¥ä¸‹å¢å¼ºï¼š

### 1. æ·»åŠ æ¨¡å‹è‡ªåŠ¨å›é€€æœºåˆ¶
- **åŸé€»è¾‘**: ä»…ä½¿ç”¨ `gemini-2.5-flash` æ¨¡å‹ã€‚
- **æ–°é€»è¾‘**: é»˜è®¤ä½¿ç”¨ `gemini-2.5-flash`ï¼Œå¦‚æœè°ƒç”¨å¤±è´¥ï¼ˆå¦‚ API Key é™åˆ¶ã€ç½‘ç»œé—®é¢˜ï¼‰ï¼Œè‡ªåŠ¨å›é€€åˆ° `gemini-flash-lite-latest`ã€‚
- **æ”¶ç›Š**: æé«˜äº†æ¸…æ´—æœåŠ¡çš„å¯ç”¨æ€§ï¼Œå‡å°‘å› å•ä¸€æ¨¡å‹æ•…éšœå¯¼è‡´çš„å¤±è´¥ã€‚

### 2. å¢å¼ºé”™è¯¯å¤„ç†ä¸æ—¥å¿—
- **JSON è§£æä¿æŠ¤**: åœ¨ `JSON.parse` å‘¨å›´æ·»åŠ äº†ä¸“é—¨çš„ try-catch å—ï¼Œå¹¶è®°å½•åŸå§‹è¿”å›æ–‡æœ¬ï¼Œä¾¿äºè°ƒè¯•ã€‚
- **è¯¦ç»†æ—¥å¿—**: 
  - æˆåŠŸæ—¶è¾“å‡ºå‹ç¼©ç‡ã€‚
  - å¤±è´¥æ—¶è¾“å‡ºå…·ä½“çš„é”™è¯¯ä¿¡æ¯å’Œå †æ ˆã€‚
  - è®°å½•æ¨¡å‹è¿”å›çš„åŸå§‹ JSON ç‰‡æ®µã€‚

### 3. ç©ºç»“æœä¿æŠ¤
- **é€»è¾‘**: å¦‚æœæ¨¡å‹è¿”å›äº†æœ‰æ•ˆçš„ JSON ä½†æå–å‡ºçš„å†…å®¹ä¸ºç©ºï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰ï¼Œç³»ç»Ÿä¼šå‘å‡ºè­¦å‘Šå¹¶è¿”å›**åŸå§‹æ–‡æœ¬**ã€‚
- **åŸå› **: é˜²æ­¢æ¨¡å‹å› è¿‡åº¦è¿‡æ»¤è€Œä¸¢å¤±æ‰€æœ‰ä¿¡æ¯ã€‚è¿”å›åŸæ–‡è™½ç„¶æ²¡æœ‰å‹ç¼©ï¼ˆ0%ï¼‰ï¼Œä½†ä¿è¯äº†ä¸Šä¸‹æ–‡ä¸ä¸¢å¤±ã€‚

## ğŸ” å¦‚ä½•æ’æŸ¥ 0% å‹ç¼©ç‡

å¦‚æœæ›´æ–°åä»ç„¶å‡ºç° 0% å‹ç¼©ç‡ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ’æŸ¥ï¼š

1. **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°** (F12 -> Console)ã€‚
2. **æŸ¥çœ‹æ—¥å¿—**: æœç´¢ `[ContextOptimization]` å…³é”®è¯ã€‚
3. **åˆ†ææƒ…å†µ**:
   - **æƒ…å†µ A**: `Fatal error, using raw context.` -> API è°ƒç”¨å®Œå…¨å¤±è´¥ï¼ˆæ£€æŸ¥ç½‘ç»œæˆ– Keyï¼‰ã€‚
   - **æƒ…å†µ B**: `JSON Parse Error` -> æ¨¡å‹è¿”å›äº†é JSON æ ¼å¼çš„å†…å®¹ï¼ˆé€šå¸¸æ˜¯æ¨¡å‹æŒ‡ä»¤éµå¾ªèƒ½åŠ›ä¸è¶³ï¼‰ã€‚
   - **æƒ…å†µ C**: `Reconstructed text is empty` -> æ¨¡å‹è®¤ä¸ºè¾“å…¥ä¸­æ²¡æœ‰å€¼å¾—ä¿ç•™çš„"äº‹å®"ï¼ˆå¯èƒ½æ˜¯è¾“å…¥å…¨æ˜¯æŒ‡ä»¤è€ŒéèƒŒæ™¯è®¾å®šï¼‰ã€‚
   - **æƒ…å†µ D**: `falling back to gemini-flash-lite-latest` -> è¯´æ˜ 2.5 Flash æ¨¡å‹ä¸å¯ç”¨ï¼Œæ­£åœ¨å°è¯• Lite æ¨¡å‹ã€‚

## ğŸ“ ä»£ç å˜æ›´

- **æ–‡ä»¶**: `services/geminiService.ts`
- **å‡½æ•°**: `optimizeContextWithAI`

```typescript
// æ ¸å¿ƒé€»è¾‘å˜æ›´ç¤ºä¾‹
try {
    jsonText = await executeOptimization('gemini-2.5-flash');
} catch (e) {
    console.warn(`Falling back to gemini-flash-lite-latest...`);
    jsonText = await executeOptimization('gemini-flash-lite-latest');
}
```

---
**ç‰ˆæœ¬**: v1.8.3 (åŒ…å«åœ¨å†…)
**æ—¶é—´**: 2025-12-04
