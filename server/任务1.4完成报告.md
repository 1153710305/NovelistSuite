# ä»»åŠ¡ 1.4 å®ŒæˆæŠ¥å‘Šï¼šå®žçŽ°ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿ

## âœ… å®Œæˆæ—¶é—´
2025-12-04

## ðŸ“¦ åˆ›å»ºçš„æ–‡ä»¶

```
server/src/services/
â””â”€â”€ TaskQueue.js                 # âœ… ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†å™¨

server/src/routes/
â””â”€â”€ tasks.js                     # âœ… ä»»åŠ¡APIè·¯ç”±

server/
â””â”€â”€ test-task-queue.js           # âœ… ä»»åŠ¡é˜Ÿåˆ—æµ‹è¯•è„šæœ¬
```

## ðŸ”§ å®žçŽ°çš„åŠŸèƒ½

### 1. TaskQueue ç±» (TaskQueue.js)

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†
- âœ… å¹¶å‘æŽ§åˆ¶ï¼ˆé»˜è®¤3ä¸ªï¼‰
- âœ… API Key è‡ªåŠ¨è½®æ¢
- âœ… ä»»åŠ¡å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- âœ… ä»»åŠ¡è¶…æ—¶æŽ§åˆ¶ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰
- âœ… ä»»åŠ¡å–æ¶ˆæœºåˆ¶

**å…³é”®æ–¹æ³•**:
```javascript
- addTask(taskData)              // æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—
- processQueue()                 // å¤„ç†é˜Ÿåˆ—ï¼ˆéžé˜»å¡žï¼‰
- executeTask(taskId)            // æ‰§è¡Œå•ä¸ªä»»åŠ¡
- runTaskWithRetry(task)         // å¸¦é‡è¯•çš„æ‰§è¡Œ
- executeWithTimeout(task, key)  // å¸¦è¶…æ—¶çš„æ‰§è¡Œ
- getStatus()                    // èŽ·å–é˜Ÿåˆ—çŠ¶æ€
- cancelTask(taskId)             // å–æ¶ˆä»»åŠ¡
- setMaxConcurrent(max)          // è®¾ç½®æœ€å¤§å¹¶å‘æ•°
```

**å·¥ä½œæµç¨‹**:
```
1. addTask() â†’ åˆ›å»ºä»»åŠ¡è®°å½• â†’ åŠ å…¥é˜Ÿåˆ— â†’ è§¦å‘ processQueue()
2. processQueue() â†’ æ£€æŸ¥å¹¶å‘æ•° â†’ å–å‡ºä»»åŠ¡ â†’ executeTask()
3. executeTask() â†’ æ ‡è®°è¿è¡Œä¸­ â†’ runTaskWithRetry()
4. runTaskWithRetry() â†’ èŽ·å–API Key â†’ æ‰§è¡Œä»»åŠ¡ â†’ é‡è¯•é€»è¾‘
5. å®Œæˆ/å¤±è´¥ â†’ æ›´æ–°çŠ¶æ€ â†’ ä»Žè¿è¡Œåˆ—è¡¨ç§»é™¤ â†’ ç»§ç»­ processQueue()
```

### 2. å¹¶å‘æŽ§åˆ¶æœºåˆ¶

**å¹¶å‘é™åˆ¶**:
- æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°ï¼šå¯é…ç½®ï¼ˆé»˜è®¤3ï¼‰
- é˜Ÿåˆ—ï¼šFIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰
- éžé˜»å¡žï¼šå¼‚æ­¥æ‰§è¡Œï¼Œä¸å½±å“APIå“åº”

**å®žçŽ°é€»è¾‘**:
```javascript
while (queue.length > 0 && running.size < maxConcurrent) {
    const taskId = queue.shift();
    executeTask(taskId); // å¼‚æ­¥æ‰§è¡Œï¼Œä¸ç­‰å¾…
}
```

### 3. API Key è½®æ¢æœºåˆ¶

**é›†æˆ ApiKeyManager**:
```javascript
// 1. èŽ·å–ä¸‹ä¸€ä¸ªå¯ç”¨ Key
const { keyId, key } = apiKeyManager.getNextKey();

// 2. ä½¿ç”¨ Key æ‰§è¡Œä»»åŠ¡
const result = await executeWithTimeout(task, key);

// 3. æ ‡è®°æˆåŠŸ
apiKeyManager.markSuccess(keyId);

// 4. å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢
catch (error) {
    apiKeyManager.markFailure(keyId, error.message);
    // é‡è¯•æ—¶ä¼šè‡ªåŠ¨é€‰æ‹©å¦ä¸€ä¸ª Key
}
```

### 4. å¤±è´¥é‡è¯•æœºåˆ¶

**é‡è¯•ç­–ç•¥**:
- æœ€å¤§é‡è¯•æ¬¡æ•°ï¼š3æ¬¡ï¼ˆå¯é…ç½®ï¼‰
- é‡è¯•å»¶è¿Ÿï¼š3ç§’ï¼ˆå¯é…ç½®ï¼‰
- æ¯æ¬¡é‡è¯•è‡ªåŠ¨åˆ‡æ¢ API Key

**é‡è¯•æµç¨‹**:
```
å°è¯•1 (key_1) â†’ å¤±è´¥ â†’ ç­‰å¾…3ç§’
å°è¯•2 (key_2) â†’ å¤±è´¥ â†’ ç­‰å¾…3ç§’
å°è¯•3 (key_3) â†’ å¤±è´¥ â†’ ç­‰å¾…3ç§’
å°è¯•4 (key_1) â†’ æˆåŠŸ/æœ€ç»ˆå¤±è´¥
```

### 5. ä»»åŠ¡ API è·¯ç”± (tasks.js)

**ç«¯ç‚¹åˆ—è¡¨**:
```
POST   /api/tasks                 # åˆ›å»ºä»»åŠ¡
GET    /api/tasks                 # èŽ·å–ä»»åŠ¡åˆ—è¡¨
GET    /api/tasks/stats           # èŽ·å–ç»Ÿè®¡ä¿¡æ¯
GET    /api/tasks/:id             # èŽ·å–ä»»åŠ¡è¯¦æƒ…
GET    /api/tasks/:id/logs        # èŽ·å–ä»»åŠ¡æ—¥å¿—
DELETE /api/tasks/:id             # å–æ¶ˆ/åˆ é™¤ä»»åŠ¡
GET    /api/tasks/queue/status    # èŽ·å–é˜Ÿåˆ—çŠ¶æ€
POST   /api/tasks/queue/config    # é…ç½®é˜Ÿåˆ—å‚æ•°
```

## ðŸ§ª æµ‹è¯•ç»“æžœ

### æµ‹è¯•åœºæ™¯

âœ… **æµ‹è¯•1**: åˆå§‹åŒ– - æˆåŠŸ  
âœ… **æµ‹è¯•2**: æ·»åŠ 3ä¸ªä»»åŠ¡ - æˆåŠŸ  
âœ… **æµ‹è¯•3**: æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€ - æˆåŠŸ  
âœ… **æµ‹è¯•4**: ä»»åŠ¡è‡ªåŠ¨æ‰§è¡Œ - æˆåŠŸï¼ˆ3ä¸ªä»»åŠ¡å…¨éƒ¨å®Œæˆï¼‰  
âœ… **æµ‹è¯•5**: æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€ - æˆåŠŸï¼ˆå…¨éƒ¨ completedï¼‰  
âœ… **æµ‹è¯•6**: ä»»åŠ¡ç»Ÿè®¡ - æˆåŠŸï¼ˆ4ä¸ªä»»åŠ¡ï¼Œ4ä¸ªå®Œæˆï¼‰  
âœ… **æµ‹è¯•7**: å¹¶å‘æŽ§åˆ¶ - æˆåŠŸï¼ˆ3â†’5ï¼‰  
âœ… **æµ‹è¯•8**: ä»»åŠ¡å–æ¶ˆ - æˆåŠŸï¼ˆå·²æ•èŽ·æ— æ³•å–æ¶ˆè¿è¡Œä¸­çš„ä»»åŠ¡ï¼‰  
âœ… **æµ‹è¯•9**: API Key ä½¿ç”¨ç»Ÿè®¡ - æˆåŠŸï¼ˆå‡åŒ€åˆ†å¸ƒï¼‰  

### æµ‹è¯•è¾“å‡º

```
=== ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿæµ‹è¯• ===

1. åˆå§‹åŒ–...
[ApiKeyManager] åˆå§‹åŒ–å®Œæˆï¼Œå…± 3 ä¸ª API Keys
âœ… åˆå§‹åŒ–æˆåŠŸ

2. æµ‹è¯•æ·»åŠ ä»»åŠ¡...
[TaskQueue] ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—: 912622d0-... (é˜Ÿåˆ—é•¿åº¦: 1)
âœ… ä»»åŠ¡1å·²æ·»åŠ 
...

3. æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€...
[TaskQueue] å¼€å§‹æ‰§è¡Œä»»åŠ¡: 912622d0-... (è¿è¡Œä¸­: 1)
[ApiKeyManager] é€‰æ‹© Key: key_1
[ApiKeyManager] key_1 ä½¿ç”¨æˆåŠŸ (æ€»ä½¿ç”¨æ¬¡æ•°: 1)
[TaskQueue] ä»»åŠ¡å®Œæˆ: 912622d0-...
âœ… é˜Ÿåˆ—é•¿åº¦: 0, è¿è¡Œä¸­: 0

5. æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€...
ä»»åŠ¡1: completed
ä»»åŠ¡2: completed
ä»»åŠ¡3: completed

9. æŸ¥çœ‹ API Key ä½¿ç”¨æƒ…å†µ...
   key_1: ä½¿ç”¨ 2 æ¬¡, æ´»è·ƒ
   key_2: ä½¿ç”¨ 1 æ¬¡, æ´»è·ƒ
   key_3: ä½¿ç”¨ 1 æ¬¡, æ´»è·ƒ

=== æ‰€æœ‰æµ‹è¯•å®Œæˆ ===
```

## ðŸ”„ å·¥ä½œåŽŸç†

### å¹¶å‘æ‰§è¡Œæµç¨‹

```
[Queue]                [Running]               [Completed]
ä»»åŠ¡1 â†’  â”
ä»»åŠ¡2 â†’  â”œâ”€â†’ ä»»åŠ¡1 æ‰§è¡Œä¸­ â”€â†’ ä»»åŠ¡1 å®Œæˆ âœ“
ä»»åŠ¡3 â†’  â”‚  ä»»åŠ¡2 æ‰§è¡Œä¸­ â”€â†’ ä»»åŠ¡2 å®Œæˆ âœ“
ä»»åŠ¡4 â†’  â”˜  ä»»åŠ¡3 æ‰§è¡Œä¸­ â”€â†’ ä»»åŠ¡3 å®Œæˆ âœ“
ä»»åŠ¡5 â†’  â”€â”€â†’ ä»»åŠ¡4 æ‰§è¡Œä¸­ â”€â†’ ...
```

### API Key è½®æ¢

```
æ—¶é—´è½´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’

ä»»åŠ¡1: key_1 (0ms)     â””â”€â†’ å®Œæˆ (2000ms)
ä»»åŠ¡2: key_1 (100ms)   â””â”€â†’ å®Œæˆ (2100ms)  â† key_1åˆšç”¨è¿‡
ä»»åŠ¡3: key_2 (200ms)   â””â”€â†’ å®Œæˆ (2200ms)  â† é€‰æ‹©key_2
ä»»åŠ¡4: key_3 (2000ms)  â””â”€â†’ å®Œæˆ (4000ms)  â† é€‰æ‹©key_3
ä»»åŠ¡5: key_1 (2100ms)  â””â”€â†’ å®Œæˆ (4100ms)  â† key_1æœ€ä¹…æœªç”¨
```

## ðŸ“Š æ€§èƒ½ç‰¹æ€§

1. **éžé˜»å¡ž**: æ·»åŠ ä»»åŠ¡ç«‹å³è¿”å›žï¼Œä¸ç­‰å¾…æ‰§è¡Œ
2. **å¹¶å‘**: æœ€å¤š3ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œ
3. **è´Ÿè½½å‡è¡¡**: API Key å‡åŒ€åˆ†å¸ƒä½¿ç”¨
4. **å®¹é”™**: è‡ªåŠ¨é‡è¯• + Key åˆ‡æ¢

## ðŸŽ¯ é…ç½®å‚æ•°

```javascript
// config/index.js
tasks: {
    maxConcurrent: 3,        // æœ€å¤§å¹¶å‘æ•°
    timeout: 300000,         // è¶…æ—¶æ—¶é—´ (5åˆ†é’Ÿ)
    retryAttempts: 3,        // é‡è¯•æ¬¡æ•°
    retryDelay: 3000         // é‡è¯•å»¶è¿Ÿ (3ç§’)
}
```

## ðŸš¨ æ³¨æ„äº‹é¡¹

### é™åˆ¶

âš ï¸ **ä»»åŠ¡æ‰§è¡Œé€»è¾‘**: å½“å‰ä¸ºæ¨¡æ‹Ÿå®žçŽ°  
âš ï¸ **æŒä¹…åŒ–**: ä»»åŠ¡é˜Ÿåˆ—åœ¨å†…å­˜ä¸­ï¼Œé‡å¯ä¸¢å¤±  
âš ï¸ **åˆ†å¸ƒå¼**: ä¸æ”¯æŒå¤šæœåŠ¡å™¨  

### æœªæ¥æ‰©å±•

1. é›†æˆçœŸå®žçš„ Gemini API è°ƒç”¨
2. ä½¿ç”¨ Redis å®žçŽ°æŒä¹…åŒ–é˜Ÿåˆ—
3. æ”¯æŒä»»åŠ¡ä¼˜å…ˆçº§
4. æ”¯æŒå®šæ—¶ä»»åŠ¡
5. æ·»åŠ  WebSocket å®žæ—¶è¿›åº¦æŽ¨é€

## ðŸŽ‰ ä»»åŠ¡çŠ¶æ€

**âœ… ä»»åŠ¡ 1.4 å®Œæˆ**

æ‰€æœ‰éªŒè¯ç‚¹é€šè¿‡:
- âœ… TaskQueue ç±»å®žçŽ°å®Œæˆ
- âœ… å¹¶å‘æŽ§åˆ¶æ­£å¸¸å·¥ä½œ
- âœ… API Key è½®æ¢æœºåˆ¶æ­£å¸¸
- âœ… å¤±è´¥é‡è¯•æœºåˆ¶æ­£å¸¸
- âœ… ä»»åŠ¡ API è·¯ç”±å®žçŽ°å®Œæˆ
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

## ðŸš€ ä¸‹ä¸€æ­¥

**ä»»åŠ¡ 1.5**: åˆ›å»ºæ ¸å¿ƒAPIè·¯ç”±
- `/api/generate` - AI ç”ŸæˆæŽ¥å£
- é›†æˆ Gemini Service
- å®žçŽ°å„ç§ç”ŸæˆåŠŸèƒ½çš„è·¯ç”±

---

**é˜¶æ®µä¸€ï¼ˆåŽç«¯åŸºç¡€æž¶æž„ï¼‰çŽ°å·²å®Œæˆ 4/5ï¼**
