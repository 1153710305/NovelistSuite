# ä»»åŠ¡ 2.2 å®ŒæˆæŠ¥å‘Šï¼šå®ç°API Keyè½®æ¢æœºåˆ¶

## âœ… å®Œæˆæ—¶é—´
2025-12-04ï¼ˆä»»åŠ¡ 1.2ï¼‰

## ğŸ“ è¯´æ˜

**ä»»åŠ¡ 2.2 å·²åœ¨ä»»åŠ¡ 1.2 ä¸­æå‰å®Œæˆï¼**

åœ¨é˜¶æ®µä¸€çš„ä»»åŠ¡ 1.2ï¼ˆé…ç½®ç¯å¢ƒå˜é‡å’ŒAPI Keyç®¡ç†ï¼‰ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†å®Œæ•´çš„ API Key è½®æ¢æœºåˆ¶ã€‚

## ğŸ”§ å·²å®ç°çš„åŠŸèƒ½

### 1. æ™ºèƒ½é€‰æ‹©ç­–ç•¥
**æ ¸å¿ƒç®—æ³•**ï¼šé€‰æ‹©"è·ç¦»ä¸Šæ¬¡ä½¿ç”¨æ—¶é—´æœ€è¿œ"çš„ Key

```javascript
getNextKey() {
    const activeKeys = Array.from(this.keyStats.values()).filter(k => k.isActive);
    
    // æ‰¾å‡ºä¸Šæ¬¡ä½¿ç”¨æ—¶é—´æœ€ä¹…è¿œçš„ Key
    let selectedKey = null;
    let oldestTime = Date.now();
    
    for (const keyInfo of activeKeys) {
        const lastUsed = keyInfo.lastUsedAt || 0;
        if (lastUsed < oldestTime) {
            oldestTime = lastUsed;
            selectedKey = keyInfo;
        }
    }
    
    return { keyId: selectedKey.keyId, key: selectedKey.key };
}
```

### 2. å¥åº·è¿½è¸ª
æ¯ä¸ª API Key ç»´æŠ¤ä»¥ä¸‹ç»Ÿè®¡ä¿¡æ¯ï¼š
- `lastUsedAt`: ä¸Šæ¬¡ä½¿ç”¨æ—¶é—´æˆ³
- `totalUsage`: æ€»ä½¿ç”¨æ¬¡æ•°
- `failCount`: å¤±è´¥æ¬¡æ•°
- `isActive`: æ˜¯å¦æ´»è·ƒ

### 3. è‡ªåŠ¨æ•…éšœéš”ç¦»
```javascript
markFailure(keyId, reason) {
    keyInfo.failCount++;
    
    // å¦‚æœè¿ç»­å¤±è´¥è¶…è¿‡5æ¬¡ï¼Œæš‚æ—¶ç¦ç”¨è¯¥ Key
    if (keyInfo.failCount >= 5) {
        keyInfo.isActive = false;
        console.error(`[ApiKeyManager] ${keyId} å·²è¢«ç¦ç”¨ï¼ˆå¤±è´¥æ¬¡æ•°è¿‡å¤šï¼‰`);
    }
}
```

### 4. æ‰‹åŠ¨æ¢å¤
```javascript
reactivateKey(keyId) {
    keyInfo.isActive = true;
    keyInfo.failCount = 0;
}
```

### 5. ç»Ÿè®¡å’Œç›‘æ§
- `getStats()`: è·å–æ‰€æœ‰ Key çš„è¯¦ç»†ç»Ÿè®¡ï¼ˆè„±æ•ï¼‰
- `getKeyCount()`: è·å– Key æ€»æ•°
- `getActiveKeyCount()`: è·å–æ´»è·ƒ Key æ•°é‡

## ğŸ§ª éªŒè¯

åœ¨ä»»åŠ¡ 1.4 çš„æµ‹è¯•ä¸­å·²éªŒè¯ï¼š
```
9. æŸ¥çœ‹ API Key ä½¿ç”¨æƒ…å†µ...
   key_1: ä½¿ç”¨ 2 æ¬¡, æ´»è·ƒ
   key_2: ä½¿ç”¨ 1 æ¬¡, æ´»è·ƒ
   key_3: ä½¿ç”¨ 1 æ¬¡, æ´»è·ƒ
```

å¯ä»¥çœ‹åˆ° Key ä½¿ç”¨æ˜¯å‡åŒ€åˆ†å¸ƒçš„ï¼ŒéªŒè¯äº†è½®æ¢æœºåˆ¶çš„æœ‰æ•ˆæ€§ã€‚

## ğŸ”„ ä¸ TaskQueue çš„é›†æˆ

åœ¨ `TaskQueue.js` ä¸­ï¼Œæ¯æ¬¡æ‰§è¡Œä»»åŠ¡æ—¶ï¼š
1. è°ƒç”¨ `apiKeyManager.getNextKey()` è·å–æœ€ä¼˜ Key
2. ä½¿ç”¨è¯¥ Key æ‰§è¡Œä»»åŠ¡
3. æˆåŠŸæ—¶è°ƒç”¨ `apiKeyManager.markSuccess(keyId)`
4. å¤±è´¥æ—¶è°ƒç”¨ `apiKeyManager.markFailure(keyId, error)`
5. å¤±è´¥åè‡ªåŠ¨é‡è¯•ï¼Œé‡è¯•æ—¶ä¼šè‡ªåŠ¨é€‰æ‹©å¦ä¸€ä¸ª Key

## ğŸ¯ æ€»ç»“

ä»»åŠ¡ 2.2 çš„æ‰€æœ‰ç›®æ ‡å·²åœ¨ä»»åŠ¡ 1.2 ä¸­å®ç°ï¼š
- âœ… æ™ºèƒ½é€‰æ‹©ç­–ç•¥ï¼ˆLRUï¼‰
- âœ… å¥åº·è¿½è¸ª
- âœ… è‡ªåŠ¨æ•…éšœéš”ç¦»
- âœ… æ‰‹åŠ¨æ¢å¤æœºåˆ¶
- âœ… ç»Ÿè®¡å’Œç›‘æ§

**æ— éœ€é¢å¤–å·¥ä½œï¼Œç›´æ¥è¿›å…¥ä»»åŠ¡ 2.3ï¼**
