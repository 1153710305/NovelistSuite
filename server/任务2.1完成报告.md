# ä»»åŠ¡ 2.1 å®ŒæˆæŠ¥å‘Šï¼šè¿ç§»GeminiåŸºç¡€æœåŠ¡

## âœ… å®Œæˆæ—¶é—´
2025-12-05

## ğŸ“¦ åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶

```
server/src/utils/
â””â”€â”€ aiUtils.js                   # âœ… æ–°å¢ï¼šAIå·¥å…·å‡½æ•°åº“

server/src/services/
â”œâ”€â”€ PromptService.js             # âœ… æ–°å¢ï¼šæç¤ºè¯æœåŠ¡
â””â”€â”€ GeminiService.js             # âœ… å‡çº§ï¼šå¢å¼ºç‰ˆGeminiæœåŠ¡

server/
â”œâ”€â”€ test-gemini-service.js       # âœ… æµ‹è¯•ï¼šå·¥å…·å‡½æ•°æµ‹è¯•
â””â”€â”€ test-gemini-full.js          # âœ… æµ‹è¯•ï¼šå®Œæ•´åŠŸèƒ½Mockæµ‹è¯•
```

## ğŸ”§ å®ç°çš„åŠŸèƒ½

### 1. åŸºç¡€å·¥å…·åº“ (aiUtils.js)
ä»å‰ç«¯è¿ç§»äº†æ ¸å¿ƒå·¥å…·å‡½æ•°ï¼š
- `cleanJson(text)`: æ™ºèƒ½æ¸…æ´— JSON å­—ç¬¦ä¸²ï¼Œç§»é™¤ Markdown æ ‡è®°
- `retryWithBackoff(fn)`: æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶
- `truncateContext(text)`: ä¸Šä¸‹æ–‡æˆªæ–­
- `handleGeminiError(error)`: ç»Ÿä¸€é”™è¯¯å¤„ç†

### 2. æç¤ºè¯æœåŠ¡ (PromptService.js)
è¿ç§»äº†æ ¸å¿ƒ Prompt ç”Ÿæˆé€»è¾‘ï¼š
- `dailyInspiration`: æ¯æ—¥çµæ„Ÿç”Ÿæˆ (åŒ…å«è¯¦ç»†çš„çº¦æŸå’Œè§„åˆ™)
- `architectureStep1`: å°è¯´æ¶æ„ç”Ÿæˆ
- `chapterContent`: ç« èŠ‚å†…å®¹ç”Ÿæˆ
- `getGlobalSystemInstruction`: å…¨å±€ç³»ç»ŸæŒ‡ä»¤

### 3. å¢å¼ºç‰ˆ GeminiService (GeminiService.js)
- **é›†æˆå·¥å…·åº“**: ä½¿ç”¨ `retryWithBackoff` å¢å¼ºç¨³å®šæ€§ï¼Œä½¿ç”¨ `cleanJson` ç¡®ä¿ JSON è§£æ
- **é›†æˆæç¤ºè¯**: åŠ¨æ€è°ƒç”¨ `PromptService` ç”Ÿæˆ Prompt
- **å®Œæ•´å®ç°**:
  - `generateDailyStories`: æ”¯æŒè‡ªå®šä¹‰è§„åˆ™ã€å¤šè¯­è¨€ã€JSON Schema æ¨¡å¼
  - `generateNovelArchitecture`: å®Œæ•´æ¶æ„ç”Ÿæˆ
  - `generateChapterContent`: æ”¯æŒå¤§çº²å’Œå­—æ•°æ§åˆ¶

## ğŸ§ª æµ‹è¯•éªŒè¯

### å·¥å…·å‡½æ•°æµ‹è¯•
- cleanJson: âœ… æˆåŠŸæ¸…æ´—å¸¦ Markdown çš„ JSON
- retryWithBackoff: âœ… æˆåŠŸé‡è¯•å¹¶æœ€ç»ˆæˆåŠŸ

### ä¸šåŠ¡é€»è¾‘æµ‹è¯• (Mock)
- æ¯æ—¥çµæ„Ÿ: âœ… Prompt ç”Ÿæˆæ­£ç¡®ï¼Œæµç¨‹è·‘é€š
- å°è¯´æ¶æ„: âœ… JSON è§£ææ­£å¸¸
- ç« èŠ‚å†…å®¹: âœ… æ–‡æœ¬ç”Ÿæˆæ­£å¸¸

## âš ï¸ å·®å¼‚è¯´æ˜

ä¸å‰ç«¯ç‰ˆæœ¬çš„å·®å¼‚ï¼š
1. **ç¯å¢ƒ**: ç§»é™¤æµè§ˆå™¨ä¸“ç”¨ä»£ç  (å¦‚ @xenova/transformers)
2. **ç±»å‹**: ä½¿ç”¨ JSDoc æ›¿ä»£ TypeScript ç±»å‹
3. **Schema**: ç®€åŒ–äº† Schema å®šä¹‰ï¼Œæ›´å¤šä¾èµ– Prompt çº¦æŸ (Gemini Node SDK å·®å¼‚)

## ğŸš€ ä¸‹ä¸€æ­¥

**ä»»åŠ¡ 2.2**: å®ç°API Keyè½®æ¢æœºåˆ¶
- è™½ç„¶ TaskQueue å·²æœ‰åŸºç¡€è½®æ¢ï¼Œéœ€è¦å¢å¼º"è·ç¦»ä¸Šæ¬¡ä½¿ç”¨æ—¶é—´æœ€è¿œ"çš„ç­–ç•¥
- è®°å½•è¯¦ç»†çš„ä½¿ç”¨ç»Ÿè®¡

**ä»»åŠ¡ 2.3**: è¿ç§»å‰©ä½™ç”ŸæˆåŠŸèƒ½
- `regenerateSingleMap`
- `expandNode`
