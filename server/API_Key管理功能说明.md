# API Key 管理功能说明

## 📋 功能概览

后端管理系统提供完整的 API Key 管理功能，包括查看、添加、删除和重新激活。

## ✅ 已实现的功能

### 1. 查看 API Keys（Read）

**功能**：查看所有已添加的 API Keys 及其详细信息

**显示信息**：
- Key ID：API Key 的唯一标识符
- 状态：激活（绿色✅）/ 已禁用（红色❌）
- 使用次数：该 Key 被使用的总次数
- 失败次数：使用该 Key 失败的次数（红色高亮显示）
- 最后使用时间：最近一次使用该 Key 的时间

**如何使用**：
1. 访问 http://localhost:3001/admin
2. 点击 "API Keys" 标签
3. 系统自动显示所有 Keys 的列表

---

### 2. 添加 API Key（Create）

**功能**：添加新的 Gemini API Key 到系统中

**如何使用**：
1. 在 "API Keys" 页面的输入框中粘贴新的 API Key
2. 点击"添加 Key"按钮
3. 系统会验证并添加该 Key
4. 成功后会显示提示信息，并刷新列表

**注意事项**：
- Key 必须是有效的 Gemini API Key 格式
- 不能添加重复的 Key
- 新添加的 Key 默认为激活状态

**API 端点**：
```
POST /api/admin/api-keys
Body: { "key": "YOUR_API_KEY_HERE" }
```

---

### 3. 删除 API Key（Delete）

**功能**：从系统中永久删除指定的 API Key

**如何使用**：
1. 在 Keys 列表中找到要删除的 Key
2. 点击该行右侧的删除按钮（🗑️图标）
3. 在确认对话框中点击"确定"
4. 系统会删除该 Key 并刷新列表

**安全提示**：
- 删除操作不可撤销
- 删除前会显示确认对话框
- 建议保留至少一个有效的 API Key

**API 端点**：
```
DELETE /api/admin/api-keys/:keyId
```

---

### 4. 重新激活 Key（Update - 状态更新）

**功能**：重新启用被自动禁用的 API Key

**使用场景**：
- 当某个 Key 失败次数过多（≥5次）时，系统会自动禁用该 Key
- 问题解决后（如充值、修复配额限制），可以重新激活

**如何使用**：
1. 在 Keys 列表中找到状态为"已禁用"的 Key
2. 点击"重新激活"按钮（🔄图标）
3. 系统会将该 Key 状态改为"激活"

**注意事项**：
- 只有被禁用的 Key 才显示重新激活按钮
- 重新激活后，失败计数会保留（不会重置为0）
- 如果 Key 仍然有问题，可能会再次被自动禁用

**API 端点**：
```
PUT /api/admin/api-keys/:keyId/reactivate
```

---

## 🔄 自动轮换机制

系统使用 **LRU (Least Recently Used)** 策略自动在多个 API Keys 之间轮换：

1. **智能选择**：每次需要调用 API 时，系统会选择最久未使用的激活 Key
2. **失败处理**：如果某个 Key 调用失败，系统会记录失败次数
3. **自动禁用**：当 Key 失败次数达到 5 次时，系统自动禁用该 Key
4. **继续轮换**：系统会自动使用其他可用的 Keys

**好处**：
- 均衡使用所有 Keys，避免单个 Key 达到限额
- 自动故障转移，提高系统可用性
- 减少手动干预，提升运维效率

---

## 📊 统计信息

每个 API Key 都会记录以下统计数据：

| 字段 | 说明 |
|------|------|
| 使用次数 | 该 Key 被成功使用的总次数 |
| 失败次数 | 该 Key 调用失败的总次数 |
| 最后使用时间 | 最近一次使用该 Key 的时间戳 |
| 状态 | 激活 / 已禁用 |

**状态说明**：
- 🟢 **激活**：Key 可正常使用，参与轮换
- 🔴 **已禁用**：Key 已被系统禁用，不参与轮换

---

## 🎯 最佳实践

### 1. 添加多个 Keys
- 建议添加至少 2-3 个 API Keys
- 可以分散请求压力，避免达到单个 Key 的限额
- 提高系统的容错能力

### 2. 定期检查状态
- 定期查看 Keys 的使用情况和失败次数
- 及时处理失败次数较高的 Keys
- 确保至少有一个 Key 处于激活状态

### 3. 监控和维护
- 关注失败次数异常增加的 Key
- 检查是否是 API 配额问题
- 必要时更换或添加新的 Keys

### 4. 安全管理
- 不要在公开场合分享 API Keys
- 定期更换 Keys
- 删除不再使用的 Keys

---

## 🔧 API 端点总览

| 方法 | 端点 | 功能 | 请求体 |
|------|------|------|--------|
| GET | `/api/admin/api-keys` | 获取所有 Keys | - |
| POST | `/api/admin/api-keys` | 添加新 Key | `{ "key": "..." }` |
| DELETE | `/api/admin/api-keys/:keyId` | 删除 Key | - |
| PUT | `/api/admin/api-keys/:keyId/reactivate` | 重新激活 Key | - |

---

## ❓ 常见问题

**Q: 添加 Key 后没有显示怎么办？**
A: 刷新页面（Ctrl+R 或 Cmd+R），确保加载了最新的数据。

**Q: 为什么 Key 会被自动禁用？**
A: 当 Key 连续失败 5 次时，系统会自动禁用该 Key，以避免继续使用有问题的 Key。

**Q: 如何知道哪个 Key 正在被使用？**
A: 查看"最后使用时间"列，最近的时间戳表示该 Key 刚被使用过。

**Q: 可以修改 API Key 本身吗？**
A: 不可以直接修改。如果需要更换 Key，请删除旧的 Key，然后添加新的 Key。

**Q: 删除 Key 后可以恢复吗？**
A: 不可以。删除操作是永久性的，请谨慎操作。

---

## 🚀 未来功能规划

可能在未来版本中添加的功能：
- 📝 为每个 Key 添加备注/别名
- 🏷️ Key 标签和分类管理
- ⚙️ 自定义 Key 优先级
- 📊 更详细的使用统计和图表
- 🔔 Key 异常告警通知
- 📤 批量导入/导出 Keys

---

*最后更新：2025-12-05*
