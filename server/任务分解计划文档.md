# 📋 任务分解计划
目标: 将 InkFlow 改造成前后端分离应用，实现API Key安全管理和并发任务调度

## 阶段一：后端基础架构搭建 (5个小任务)
任务 1.1: 创建后端项目结构

* 在项目根目录创建 server 文件夹
* 初始化 Node.js 项目 (package.json)
* 安装依赖: Express, cors, dotenv, body-parser
* 创建基本的文件结构
* 验证: 运行基础服务器，访问健康检查端点

任务 1.2: 配置环境变量和API Key管理

* 创建 .env.server 文件用于存储API Keys
* 创建 ApiKeyManager 类管理API Key池
* 实现API Key的加载、选择、更新逻辑
* 验证: 测试API Key池的初始化和选择算法

任务 1.3: 创建数据库模型

* 选择数据库方案（SQLite用于开发，后续可升级）
* 创建数据模型：Tasks, ApiKeys, TaskLogs
* 实现基础CRUD操作
* 验证: 测试数据存储和查询

任务 1.4: 实现任务队列系统

* 创建 TaskQueue 类
* 实现任务的添加、执行、并发控制
* 实现任务状态管理 (pending/running/completed/failed)
* 验证: 测试任务队列的并发执行

任务 1.5: 创建核心API路由

* /api/tasks - 任务管理
* /api/generate - AI生成接口
* /api/health - 健康检查
* 验证: 使用Postman/curl测试所有端点

## 阶段二：Gemini服务迁移 (4个小任务)
任务 2.1: 迁移Gemini基础服务

* 将 geminiService.ts的核心逻辑迁移到后端
* 创建 GeminiClient 类封装API调用
* 实现错误处理和重试机制
* 验证: 测试基础AI生成功能

任务 2.2: 实现API Key轮换机制

* 在任务失败时自动切换API Key
* 记录API Key使用历史和频率
* 实现"距离上次使用时间最远"的选择策略
* 验证: 模拟API Key失败，验证自动切换

任务 2.3: 迁移核心生成功能

* 迁移 generateDailyStories
* 迁移 generateNovelArchitecture
* 迁移 generateChapterContent
* 迁移 regenerateSingleMap
* 验证: 逐个测试每个生成功能

任务 2.4: 实现任务进度推送

* 使用Server-Sent Events (SSE) 或 WebSocket
* 实现实时进度更新
* 验证: 前端能实时接收任务进度

## 阶段三：前端适配 (3个小任务)
任务 3.1: 创建后端API客户端

* 创建 services/backendApi.ts
* 封装所有后端请求
* 处理认证（如需要）
* 验证: 测试API调用成功

任务 3.2: 重构前端服务层

* 修改 geminiService.ts为代理层
* 将AI请求转发到后端
* 保持前端接口不变
* 验证: 前端功能正常工作

任务 3.3: 移除前端API Key

* 清理 .env 中的敏感信息
* 更新环境变量配置文档
* 验证: 前端代码中无API Key痕迹

## 阶段四：管理界面开发 (6个小任务)
任务 4.1: 创建管理界面路由

* 在后端添加 /admin 路由
* 实现简单的认证机制
* 验证: 访问管理界面成功

任务 4.2: API Key管理界面

* 列表显示所有API Keys
* 增删改查功能
* 显示使用统计
* 验证: CRUD操作正常工作

任务 4.3: 任务监控界面

* 实时显示任务列表
* 显示任务状态、进度、使用的API Key
* 显示错误信息和日志
* 验证: 实时更新正常

任务 4.4: 并发设置界面

* 设置最大并发任务数
* 设置任务超时时间
* 设置重试策略
* 验证: 配置生效

任务 4.5: 统计仪表板

* 显示总任务数、成功率
* API Key使用分布
* 性能指标（平均响应时间等）
* 验证: 数据准确

任务 4.6: 日志查看器

* 查看详细的任务执行日志
* 过滤和搜索功能
* 验证: 日志完整准确

## 阶段五：测试和优化 (3个小任务)

任务 5.1: 集成测试

* 端到端测试所有功能
* 压力测试并发性能
* 验证: 稳定运行无崩溃

任务 5.2: 错误处理优化

* 完善所有错误场景
* 添加友好的错误提示
* 验证: 各种异常都能正确处理

任务 5.3: 性能优化

* 优化数据库查询
* 添加缓存机制
* 验证: 响应时间满足要求

## 阶段六：文档和部署 (2个小任务)
任务 6.1: 更新文档

* 更新 README.md
* 创建部署指南
* 创建API文档
* 验证: 文档完整清晰

任务 6.2: 配置部署脚本

* 创建 Docker 配置
* 创建启动脚本
* 验证: 一键部署成功

🎯 总计：23个小任务
建议按照上述顺序逐步完成。

创建后端项目结构，并逐步完成每个任务。每完成一个任务，会暂停让您验证结果，确认无误后再继续下一个。