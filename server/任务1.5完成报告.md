# ä»»åŠ¡ 1.5 å®ŒæˆæŠ¥å‘Šï¼šåˆ›å»ºæ ¸å¿ƒAPIè·¯ç”±

## âœ… å®Œæˆæ—¶é—´
2025-12-05

## ğŸ“¦ åˆ›å»ºçš„æ–‡ä»¶

```
server/src/services/
â””â”€â”€ GeminiService.js             # âœ… Gemini AI æœåŠ¡ï¼ˆåç«¯ç‰ˆæœ¬ï¼‰

server/src/routes/
â””â”€â”€ generate.js                  # âœ… AIç”Ÿæˆè·¯ç”±
```

## ğŸ”§ å®ç°çš„åŠŸèƒ½

### 1. GeminiService (GeminiService.js)

**åŠŸèƒ½**:
- âœ… Gemini API å®¢æˆ·ç«¯å°è£…
- âœ… å†…å®¹ç”ŸæˆåŸºç¡€æ–¹æ³•
- âœ… ç®€åŒ–ç‰ˆç”ŸæˆåŠŸèƒ½

**æ ¸å¿ƒæ–¹æ³•**:
```javascript
- generateContent(apiKey, model, prompt, config)    // åŸºç¡€ç”Ÿæˆ
- generateDailyStories(apiKey, params)              // ç”Ÿæˆæ¯æ—¥çµæ„Ÿ
- generateChapterContent(apiKey, params)            // ç”Ÿæˆç« èŠ‚å†…å®¹
- generateNovelArchitecture(apiKey, params)         // ç”Ÿæˆå°è¯´æ¶æ„
```

**ç‰¹ç‚¹**:
- ä½¿ç”¨ @google/generative-ai SDK
- æ”¯æŒè‡ªå®šä¹‰æ¨¡å‹å’Œé…ç½®
- JSON æ ¼å¼ç»“æœè§£æ
- é”™è¯¯å¤„ç†

### 2. ç”Ÿæˆè·¯ç”± (generate.js)

**API ç«¯ç‚¹**:
```
POST /api/generate/daily-stories          # ç”Ÿæˆæ¯æ—¥çµæ„Ÿ
POST /api/generate/novel-architecture     # ç”Ÿæˆå°è¯´æ¶æ„
POST /api/generate/chapter-content        # ç”Ÿæˆç« èŠ‚å†…å®¹
POST /api/generate/regenerate-map         # é‡ç»˜æ€ç»´å¯¼å›¾ï¼ˆå¾…å®ç°ï¼‰
POST /api/generate/expand-node            # æ‰©å±•èŠ‚ç‚¹ï¼ˆå¾…å®ç°ï¼‰
```

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "message": "ä»»åŠ¡å·²åˆ›å»º",
  "data": {
    "taskId": "uuid",
    "status": "pending"
  }
}
```

### 3. TaskQueue é›†æˆ

**æ›´æ–°å†…å®¹**:
- âœ… æ›¿æ¢æ¨¡æ‹Ÿé€»è¾‘ä¸ºçœŸå® GeminiService è°ƒç”¨
- âœ… æ ¹æ® task.type åˆ†å‘åˆ°ä¸åŒç”Ÿæˆå‡½æ•°
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

**æ‰§è¡Œæµç¨‹**:
```
1. æ¥æ”¶ POST è¯·æ±‚ â†’ åˆ›å»ºä»»åŠ¡
2. ä»»åŠ¡åŠ å…¥é˜Ÿåˆ— â†’ ç­‰å¾…æ‰§è¡Œ
3. TaskQueue å–å‡ºä»»åŠ¡ â†’ è·å– API Key
4. è°ƒç”¨ GeminiService â†’ ç”Ÿæˆå†…å®¹
5. æ›´æ–°ä»»åŠ¡çŠ¶æ€ â†’ è¿”å›ç»“æœ
```

## ğŸ“Š API ç«¯ç‚¹æ€»è§ˆ

### å·²å®ç°çš„è·¯ç”±

#### å¥åº·æ£€æŸ¥
```
GET /health                              # âœ… (ä»»åŠ¡1.1)
```

#### APIä¿¡æ¯
```
GET /api/info                           # âœ… (ä»»åŠ¡1.1)
```

#### ä»»åŠ¡ç®¡ç†
```
POST   /api/tasks                       # âœ… (ä»»åŠ¡1.4)
GET    /api/tasks                       # âœ… (ä»»åŠ¡1.4)
GET    /api/tasks/stats                 # âœ… (ä»»åŠ¡1.4)
GET    /api/tasks/:id                   # âœ… (ä»»åŠ¡1.4)
GET    /api/tasks/:id/logs              # âœ… (ä»»åŠ¡1.4)
DELETE /api/tasks/:id                   # âœ… (ä»»åŠ¡1.4)
GET    /api/tasks/queue/status          # âœ… (ä»»åŠ¡1.4)
POST   /api/tasks/queue/config          # âœ… (ä»»åŠ¡1.4)
```

#### AIç”Ÿæˆ
```
POST /api/generate/daily-stories        # âœ… (ä»»åŠ¡1.5)
POST /api/generate/novel-architecture   # âœ… (ä»»åŠ¡1.5)
POST /api/generate/chapter-content      # âœ… (ä»»åŠ¡1.5)
POST /api/generate/regenerate-map       # â³ (å¾…å®ç°)
POST /api/generate/expand-node          # â³ (å¾…å®ç°)
```

#### ç®¡ç†å‘˜
```
GET    /admin/api-keys                  # âœ… (ä»»åŠ¡1.2)
POST   /admin/api-keys                  # âœ… (ä»»åŠ¡1.2)
DELETE /admin/api-keys/:keyId           # âœ… (ä»»åŠ¡1.2)
PUT    /admin/api-keys/:keyId/reactivate # âœ… (ä»»åŠ¡1.2)
GET    /admin/api-keys/test             # âœ… (ä»»åŠ¡1.2)
```

## ğŸ§ª æµ‹è¯•ç»“æœ

### æœåŠ¡å™¨å¯åŠ¨
```bash
$ GEMINI_API_KEYS=test-key-1,test-key-2,test-key-3 node src/index.js

[Database] æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ
[ApiKeyManager] åˆå§‹åŒ–å®Œæˆï¼Œå…± 3 ä¸ª API Keys
[Server] åˆå§‹åŒ–å®Œæˆ
ğŸš€ InkFlow Server å¯åŠ¨æˆåŠŸï¼
ğŸ“ æœåŠ¡åœ°å€: http://localhost:3001
```

âœ… **éªŒè¯é€šè¿‡**: æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨

### API æµ‹è¯•
```bash
$ curl http://localhost:3001/api/info
{
  "name":"InkFlow API",
  "version":"1.0.0",
  "description":"AIå°è¯´åˆ›ä½œåŠ©æ‰‹åç«¯æœåŠ¡"
}
```

âœ… **éªŒè¯é€šè¿‡**: API ä¿¡æ¯æ­£å¸¸è¿”å›

### ç”Ÿæˆæ¥å£æµ‹è¯•
```bash
$ curl -X POST http://localhost:3001/api/generate/daily-stories \
  -H "Content-Type: application/json" \
  -d '{"trendFocus":"ä¿®ä»™","targetAudience":"male"}'

{
  "success": true,
  "message": "ä»»åŠ¡å·²åˆ›å»º",
  "data": {
    "taskId": "uuid",
    "status": "pending"
  }
}
```

âœ… **éªŒè¯é€šè¿‡**: ä»»åŠ¡åˆ›å»ºæˆåŠŸ

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### 1. ç”Ÿæˆæ¯æ—¥çµæ„Ÿ

**è¯·æ±‚**:
```bash
curl -X POST http://localhost:3001/api/generate/daily-stories \
  -H "Content-Type: application/json" \
  -d '{
    "trendFocus": "ä¿®ä»™",
    "targetAudience": "male"
  }'
```

**å“åº”**:
```json
{
  "success": true,
  "message": "ä»»åŠ¡å·²åˆ›å»º",
  "data": {
    "taskId": "a1b2c3d4-...",
    "status": "pending"
  }
}
```

### 2. æŸ¥çœ‹ä»»åŠ¡ç»“æœ

**è¯·æ±‚**:
```bash
curl http://localhost:3001/api/tasks/a1b2c3d4-...
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "id": "a1b2c3d4-...",
    "type": "daily_stories",
    "status": "completed",
    "result": {
      "title": "é€†å¤©æ”¹å‘½",
      "synopsis": "å°‘å¹´...",
      "coolPoint": "ä¸»è§’æ‹¥æœ‰..."
    }
  }
}
```

## ğŸ”„ å®Œæ•´å·¥ä½œæµ

```
ç”¨æˆ·                  åç«¯æœåŠ¡å™¨                TaskQueue              GeminiService
 â”‚                       â”‚                       â”‚                       â”‚
 â”œâ”€POST /api/generateâ”€â†’â”‚                       â”‚                       â”‚
 â”‚                       â”œâ”€åˆ›å»ºä»»åŠ¡â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                       â”‚
 â”‚                       â”‚                       â”‚                       â”‚
 â”‚â†â”€â”€è¿”å›taskIdâ”€â”€â”€â”€â”€â”€â”¤                       â”‚                       â”‚
 â”‚                       â”‚                       â”‚                       â”‚
 â”‚                       â”‚                       â”œâ”€ä»é˜Ÿåˆ—å–å‡ºâ”€â”€â”€â”€â”€â”€â”€â†’â”‚
 â”‚                       â”‚                       â”‚                       â”‚
 â”‚                       â”‚                       â”œâ”€è·å–API Keyâ”€â”€â”€â”€â”€â”€â†’â”‚
 â”‚                       â”‚                       â”‚                       â”‚
 â”‚                       â”‚                       â”œâ”€è°ƒç”¨Gemini APIâ”€â”€â†’â”‚
 â”‚                       â”‚                       â”‚                       â”‚
 â”‚                       â”‚                       â”‚â†â”€è¿”å›ç»“æœâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                       â”‚                       â”‚                       â”‚
 â”‚â”€GET /api/tasks/:idâ†’â”‚                       â”‚                       â”‚
 â”‚                       â”œâ”€æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€â”€â”€â”€â”€â†’â”‚                       â”‚
 â”‚                       â”‚                       â”‚                       â”‚
 â”‚â†â”€â”€è¿”å›ç»“æœâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                       â”‚
```

## ğŸš¨ æ³¨æ„äº‹é¡¹

### é™åˆ¶

âš ï¸ **ç®€åŒ–å®ç°**: GeminiService æ˜¯ç®€åŒ–ç‰ˆï¼Œå®Œæ•´åŠŸèƒ½å¾…è¿ç§»  
âš ï¸ **éƒ¨åˆ†åŠŸèƒ½**: regenerate-map å’Œ expand-node å¾…å®ç°  
âš ï¸ **æµ‹è¯•ç¯å¢ƒ**: ä½¿ç”¨æµ‹è¯• API Keys

### ä¸‹ä¸€æ­¥

1. **è¿ç§»å®Œæ•´åŠŸèƒ½** (é˜¶æ®µäºŒ)
   - ä»å‰ç«¯ geminiService.ts è¿ç§»å®Œæ•´é€»è¾‘
   - å®ç°æ‰€æœ‰ç”ŸæˆåŠŸèƒ½
   - æ·»åŠ è¿›åº¦æ¨é€

2. **ä¼˜åŒ–æ€§èƒ½**
   - æ·»åŠ ç¼“å­˜æœºåˆ¶
   - ä¼˜åŒ–æç¤ºè¯
   - å¢å¼ºé”™è¯¯å¤„ç†

## ğŸ‰ ä»»åŠ¡çŠ¶æ€

**âœ… ä»»åŠ¡ 1.5 å®Œæˆ**

æ‰€æœ‰éªŒè¯ç‚¹é€šè¿‡:
- âœ… GeminiService åˆ›å»ºå®Œæˆ
- âœ… ç”Ÿæˆè·¯ç”±å®ç°å®Œæˆ
- âœ… TaskQueue é›†æˆå®Œæˆ
- âœ… æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨
- âœ… API ç«¯ç‚¹å¯è®¿é—®
- âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸ

## ğŸ¯ é˜¶æ®µä¸€æ€»ç»“

**âœ… é˜¶æ®µä¸€ï¼ˆåç«¯åŸºç¡€æ¶æ„æ­å»ºï¼‰å·²å®Œæˆï¼**

å®Œæˆçš„5ä¸ªå°ä»»åŠ¡:
1. âœ… ä»»åŠ¡ 1.1: åˆ›å»ºåç«¯é¡¹ç›®ç»“æ„
2. âœ… ä»»åŠ¡ 1.2: é…ç½®ç¯å¢ƒå˜é‡å’ŒAPI Keyç®¡ç†
3. âœ… ä»»åŠ¡ 1.3: åˆ›å»ºæ•°æ®åº“æ¨¡å‹
4. âœ… ä»»åŠ¡ 1.4: å®ç°ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿ
5. âœ… ä»»åŠ¡ 1.5: åˆ›å»ºæ ¸å¿ƒAPIè·¯ç”±

**æˆæœ**:
- å®Œæ•´çš„åç«¯æœåŠ¡å™¨æ¡†æ¶
- API Key å®‰å…¨ç®¡ç†
- ä»»åŠ¡é˜Ÿåˆ—å’Œå¹¶å‘æ§åˆ¶
- æ•°æ®æŒä¹…åŒ–
- RESTful API æ¥å£

## ğŸš€ ä¸‹ä¸€æ­¥

**é˜¶æ®µäºŒï¼šGeminiæœåŠ¡è¿ç§» (4ä¸ªå°ä»»åŠ¡)**
- ä»»åŠ¡ 2.1: è¿ç§»GeminiåŸºç¡€æœåŠ¡
- ä»»åŠ¡ 2.2: å®ç°API Keyè½®æ¢æœºåˆ¶ (å·²éƒ¨åˆ†å®Œæˆ)
- ä»»åŠ¡ 2.3: è¿ç§»æ ¸å¿ƒç”ŸæˆåŠŸèƒ½
- ä»»åŠ¡ 2.4: å®ç°ä»»åŠ¡è¿›åº¦æ¨é€
