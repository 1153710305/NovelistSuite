# ä»»åŠ¡ 3.1 å®ŒæˆæŠ¥å‘Šï¼šåˆ›å»ºåç«¯APIå®¢æˆ·ç«¯

## âœ… å®Œæˆæ—¶é—´
2025-12-05

## ğŸ“¦ åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶

```
services/
â””â”€â”€ backendApi.ts                # âœ… æ–°å¢ï¼šåç«¯ API å®¢æˆ·ç«¯

.env.example                     # âœ… æ›´æ–°ï¼šæ·»åŠ åç«¯ URL é…ç½®
```

## ğŸ”§ å®ç°çš„åŠŸèƒ½

### 1. BackendAPI å®¢æˆ·ç«¯ (backendApi.ts)

**æ ¸å¿ƒåŠŸèƒ½**:
- ç»Ÿä¸€çš„ HTTP è¯·æ±‚å°è£…
- å®Œæ•´çš„ç±»å‹å®šä¹‰ï¼ˆTypeScriptï¼‰
- é”™è¯¯å¤„ç†
- è‡ªåŠ¨ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–

**API åˆ†ç±»**:

#### å¥åº·æ£€æŸ¥
```typescript
BackendAPI.health()
BackendAPI.info()
```

#### ä»»åŠ¡ç®¡ç†
```typescript
BackendAPI.tasks.create(data)
BackendAPI.tasks.list(params)
BackendAPI.tasks.get(taskId)
BackendAPI.tasks.logs(taskId, params)
BackendAPI.tasks.delete(taskId)
BackendAPI.tasks.stats()
BackendAPI.tasks.queueStatus()
BackendAPI.tasks.configQueue(config)
```

#### AI ç”Ÿæˆ
```typescript
BackendAPI.generate.dailyStories(params)
BackendAPI.generate.novelArchitecture(params)
BackendAPI.generate.chapterContent(params)
BackendAPI.generate.regenerateMap(params)
BackendAPI.generate.expandNode(params)
```

#### ç®¡ç†å‘˜
```typescript
BackendAPI.admin.getApiKeys()
BackendAPI.admin.addApiKey(key)
BackendAPI.admin.deleteApiKey(keyId)
BackendAPI.admin.reactivateApiKey(keyId)
BackendAPI.admin.testApiKeys()
```

### 2. è½®è¯¢è¾…åŠ©å‡½æ•°

**`pollTaskResult`**:
- è‡ªåŠ¨è½®è¯¢ä»»åŠ¡çŠ¶æ€
- æ”¯æŒè¿›åº¦å›è°ƒ
- å¯é…ç½®è½®è¯¢é—´éš”å’Œæœ€å¤§æ¬¡æ•°
- è‡ªåŠ¨å¤„ç†å®Œæˆ/å¤±è´¥/å–æ¶ˆçŠ¶æ€

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
// åˆ›å»ºä»»åŠ¡
const { data } = await BackendAPI.generate.dailyStories({
    trendFocus: 'èµ›åšä¿®ä»™',
    targetAudience: 'male'
});

// è½®è¯¢ç»“æœ
const result = await pollTaskResult(
    data.taskId,
    (task) => console.log(`è¿›åº¦: ${task.progress}%`),
    60,  // æœ€å¤šè½®è¯¢ 60 æ¬¡
    2000 // æ¯ 2 ç§’è½®è¯¢ä¸€æ¬¡
);

console.log('ç”Ÿæˆç»“æœ:', result);
```

### 3. ç¯å¢ƒå˜é‡é…ç½®

**`.env.example` æ›´æ–°**:
```bash
# åç«¯æœåŠ¡å™¨åœ°å€ï¼ˆå‰åç«¯åˆ†ç¦»æ¶æ„ï¼‰
NEXT_PUBLIC_BACKEND_URL=http://localhost:3001
```

**ä½¿ç”¨è¯´æ˜**:
ç”¨æˆ·éœ€è¦åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š
```bash
NEXT_PUBLIC_BACKEND_URL=http://localhost:3001
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: ç”Ÿæˆæ¯æ—¥çµæ„Ÿ

```typescript
import BackendAPI, { pollTaskResult } from '@/services/backendApi';

async function generateStories() {
    try {
        // 1. åˆ›å»ºä»»åŠ¡
        const { data } = await BackendAPI.generate.dailyStories({
            trendFocus: 'èµ›åšä¿®ä»™',
            targetAudience: 'male',
            lang: 'zh',
            model: 'gemini-2.0-flash-exp'
        });

        console.log('ä»»åŠ¡å·²åˆ›å»º:', data.taskId);

        // 2. è½®è¯¢ç»“æœ
        const result = await pollTaskResult(
            data.taskId,
            (task) => {
                console.log(`çŠ¶æ€: ${task.status}, è¿›åº¦: ${task.progress}%`);
            }
        );

        console.log('ç”Ÿæˆç»“æœ:', result);
        return result;
    } catch (error) {
        console.error('ç”Ÿæˆå¤±è´¥:', error);
        throw error;
    }
}
```

### ç¤ºä¾‹ 2: æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨

```typescript
async function listTasks() {
    const { data } = await BackendAPI.tasks.list({
        status: 'completed',
        limit: 10
    });

    console.log('å·²å®Œæˆçš„ä»»åŠ¡:', data);
}
```

### ç¤ºä¾‹ 3: ç®¡ç† API Keys

```typescript
async function manageApiKeys() {
    // è·å–æ‰€æœ‰ Keys
    const { data: keys } = await BackendAPI.admin.getApiKeys();
    console.log('API Keys:', keys);

    // æ·»åŠ æ–° Key
    await BackendAPI.admin.addApiKey('new-api-key-here');

    // é‡æ–°å¯ç”¨ Key
    await BackendAPI.admin.reactivateApiKey('key_1');
}
```

## ğŸ¯ è®¾è®¡ç‰¹ç‚¹

### 1. ç±»å‹å®‰å…¨
- å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- IDE è‡ªåŠ¨è¡¥å…¨

### 2. é”™è¯¯å¤„ç†
- ç»Ÿä¸€çš„é”™è¯¯æ•è·
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- å‹å¥½çš„é”™è¯¯ä¿¡æ¯

### 3. çµæ´»é…ç½®
- é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®åç«¯åœ°å€
- æ”¯æŒå¼€å‘/ç”Ÿäº§ç¯å¢ƒåˆ‡æ¢

### 4. æ˜“äºä½¿ç”¨
- æ¸…æ™°çš„ API åˆ†ç±»
- ç®€æ´çš„è°ƒç”¨æ–¹å¼
- å®Œå–„çš„è¾…åŠ©å‡½æ•°

## ğŸš€ ä¸‹ä¸€æ­¥

**ä»»åŠ¡ 3.2**: é‡æ„å‰ç«¯æœåŠ¡å±‚
- ä¿®æ”¹ `geminiService.ts` ä¸ºä»£ç†å±‚
- å°† AI è¯·æ±‚è½¬å‘åˆ°åç«¯
- ä¿æŒå‰ç«¯æ¥å£ä¸å˜ï¼ˆå‘åå…¼å®¹ï¼‰

---

**ä»»åŠ¡ 3.1 å®Œæˆï¼åç«¯ API å®¢æˆ·ç«¯å·²å°±ç»ªã€‚**
