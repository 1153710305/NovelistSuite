# 市场趋势分析优化说明

## 问题描述

### 问题1: 返回结果格式不符合预期
**现象**: 分析市场趋势时,AI有时返回"根据搜索到的信息,一些上榜或被推荐的作品"这样的描述性文本,而不是纯净的关键词。

**原因**: 
- 提示词约束不够明确,AI理解为需要提供分析性回答
- 缺少对AI输出结果的后处理和清洗

### 问题2: Gemini 3.0 Pro 模型分析时间过长
**现象**: 使用 Gemini 3.0 Pro 模型进行市场趋势分析时,耗时较长。

**原因**: 
- Google Search 工具需要进行实时搜索,增加了响应时间
- 3.0 Pro 模型本身处理速度相对较慢
- 提示词较长,增加了处理时间

## 解决方案

### 1. 强化提示词约束 (promptService.ts)

**优化前**:
```typescript
analyzeTrend: (sources: string[]): string => {
    return `
    任务：作为一名资深网文市场分析师,请根据以下来源的近期热门内容,提取一个最具"爆款潜力"的题材关键词或核心梗。
    来源参考:${sources.join(', ')}
    
    要求:
    1. 只返回一个具体的关键词(例如:"赛博修仙"、"规则怪谈"、"年代文后妈"、"全家读心")。
    2. 不要解释,不要标点,只要那个词。
    `;
}
```

**优化后**:
```typescript
analyzeTrend: (sources: string[]): string => {
    return `
请使用 Google Search 搜索最新的网络小说排行榜,来源:${sources.join('、')}。

【任务】:分析当前最热门的题材,提取一个最具"爆款潜力"的核心关键词。

【输出格式】:
- 只输出一个2-6字的关键词
- 不要任何解释、标点、序号
- 不要说"根据搜索"、"推荐"等描述性文字
- 直接输出关键词本身

【示例】:
正确:赛博修仙
错误:根据搜索到的信息,推荐"赛博修仙"
错误:1. 赛博修仙

现在请输出关键词:
    `;
}
```

**改进点**:
- 使用更清晰的格式化结构(【任务】、【输出格式】、【示例】)
- 明确字数限制(2-6字)
- 提供正确和错误的示例对比
- 强调"不要说'根据搜索'"等具体禁止项

### 2. 服务端关键词清洗 (geminiService.ts)

在 `analyzeTrendKeywords` 函数中添加了完整的后处理逻辑:

```typescript
// 后处理:清洗AI返回的文本,提取纯净关键词
let rawResult = response.text?.trim() || "热门趋势";
let cleanedKeyword = rawResult;

// 1. 去除常见描述性前缀
const prefixPatterns = [
    /^根据.*?[，,：:]/,
    /^搜索.*?[，,：:]/,
    /^分析.*?[，,：:]/,
    /^推荐.*?[，,：:]/,
    /^一些.*?[，,：:]/,
    /^当前.*?[，,：:]/,
    /^热门.*?[，,：:]/,
    /^上榜.*?[，,：:]/,
    /^被推荐.*?[，,：:]/
];

for (const pattern of prefixPatterns) {
    cleanedKeyword = cleanedKeyword.replace(pattern, '');
}

// 2. 按行分割,取第一个非空行
const lines = cleanedKeyword.split(/[\n\r]+/).map(l => l.trim()).filter(l => l);
if (lines.length > 0) {
    cleanedKeyword = lines[0];
}

// 3-9. 其他清洗步骤...
```

**清洗步骤**:
1. 去除描述性前缀(根据、搜索、分析、推荐等)
2. 按行分割,取第一个非空行
3. 去除序号(1. 2. 一、等)
4. 去除markdown格式(**, __, 等)
5. 去除引号
6. 提取冒号前的内容
7. 如果太长,按标点分割
8. 最终清理首尾特殊字符
9. 验证结果,失败则使用默认值

### 3. 客户端关键词提取增强 (Studio.tsx)

在 `handleAnalyzeTrend` 函数中也添加了类似的清洗逻辑,作为双重保障:

```typescript
// 优化显示:提取纯净的关键词
let displayTrend = trend.trim();

// 1. 去除常见的描述性前缀
const prefixPatterns = [
    /^根据.*?[，,：:]/,
    /^搜索.*?[，,：:]/,
    // ... 更多模式
];

// 2-9. 完整的清洗流程
```

**双层防护**:
- 服务端清洗:确保返回给客户端的数据已经是纯净的
- 客户端清洗:作为额外保障,处理可能的边缘情况

### 4. 日志记录

添加了详细的日志记录,便于调试:

```typescript
// 9. 验证结果
if (!cleanedKeyword || cleanedKeyword.length < 2) {
    console.warn('[analyzeTrendKeywords] 清洗后关键词无效,使用默认值。原始结果:', rawResult);
    cleanedKeyword = '玄幻';
}
```

## 优化效果

### 问题1解决效果
- ✅ 提示词更明确,AI理解更准确
- ✅ 双层清洗机制,确保输出纯净关键词
- ✅ 处理多种边缘情况(序号、引号、markdown等)
- ✅ 添加日志记录,便于问题追踪

### 问题2优化建议
虽然本次主要解决了问题1,但对于问题2(时间过长),提供以下建议:

**短期方案**:
1. 提示词已优化,减少了不必要的描述
2. 清洗逻辑在客户端执行,不影响API调用时间

**长期优化方向**:
1. **模型选择**: 考虑使用更快的模型(如 gemini-2.5-flash)进行趋势分析
2. **缓存机制**: 对相同来源的趋势分析结果进行缓存(如1小时内)
3. **并行处理**: 如果需要分析多个来源,可以考虑并行调用
4. **预加载**: 在用户打开页面时预先加载常用来源的趋势

## 测试建议

1. **正常情况测试**:
   - 选择不同的来源组合(起点、番茄、晋江)
   - 验证返回的关键词是否纯净(2-6字,无描述性前缀)

2. **边缘情况测试**:
   - AI返回带序号的结果(1. 赛博修仙)
   - AI返回带引号的结果("赛博修仙")
   - AI返回带冒号的结果(推荐:赛博修仙)
   - AI返回多行结果

3. **性能测试**:
   - 记录不同模型的响应时间
   - 对比优化前后的时间差异

## 文件修改清单

1. **services/promptService.ts** - 优化趋势分析提示词
2. **services/geminiService.ts** - 添加服务端关键词清洗逻辑
3. **pages/Studio.tsx** - 增强客户端关键词提取
4. **README.md** - 更新项目文档,记录优化内容

## 总结

本次优化通过"提示词强化 + 双层清洗"的方案,有效解决了市场趋势分析返回格式不符合预期的问题。同时为性能优化提供了方向性建议。所有修改都遵循了项目的编程规范,添加了完整的中文注释。
