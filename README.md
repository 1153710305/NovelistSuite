

# InkFlow AI - 智能小说创作套件 (Novelist Suite)

**InkFlow AI** 是一款专为网络小说作者打造的本地优先（Local-First）智能创作系统。它深度集成了 Google Gemini API，提供从市场趋势分析、灵感爆发、结构设计到正文辅助写作的全流程支持。

## 🛠 技术栈与开发环境

### 核心技术
*   **开发语言**: TypeScript (v5.x)
*   **前端框架**: React 19
*   **构建工具**: Vite
*   **样式方案**: Tailwind CSS
*   **AI 模型库**: `@google/genai` (Google Gemini SDK)
*   **状态管理**: React Context API + Hooks
*   **数据持久化**: Browser LocalStorage (无后端架构)
*   **可视化**: D3.js (思维导图), Recharts (数据图表)

### 开发环境要求
*   **Node.js**: v18.0.0 或更高版本
*   **包管理器**: npm 或 yarn
*   **API Key**: 需要有效的 Google AI Studio API Key (支持 Gemini 2.5/3.0 模型)

## 📂 项目结构说明

```text
/
├── components/         # 通用 UI 组件
│   ├── Layout.tsx      # 应用主布局框架
│   ├── MindMap.tsx     # D3.js 思维导图组件
│   ├── TaskMonitor.tsx # 全局后台任务监控器
│   └── ...
├── contexts/           # 全局状态管理
│   └── AppContext.tsx  # 核心状态 (设置, 任务队列, 全局数据)
├── pages/              # 路由页面模块
│   ├── Dashboard.tsx   # 仪表盘 (数据分析)
│   ├── Studio.tsx      # 写作工作室 (核心功能)
│   ├── Architect.tsx   # 故事架构师 (大纲设计)
│   ├── Market.tsx      # 市场拆解
│   ├── Workflow.tsx    # 自动化工作流
│   └── ...
├── services/           # 业务逻辑服务层
│   ├── geminiService.ts # Google Gemini API 交互核心
│   ├── promptService.ts # 提示词工程中心
│   ├── storageService.ts # 本地存储封装
│   └── logger.ts       # 系统日志服务
├── types.ts            # TypeScript 类型定义 (核心数据模型)
├── i18n.tsx            # 国际化配置
├── index.tsx           # 应用入口
└── App.tsx             # 根组件与路由分发
```

## 🌟 核心功能模块

### 1. 写作工作室 (Studio)
核心创作界面。采用 **"8-图架构体系" (8-Map Architecture)**，将小说结构化为世界观、角色、剧情等 8 个维度的思维导图。AI 在生成正文时会自动检索这些导图作为上下文，保证长篇连载的逻辑一致性。
- **Flexible Context**: 支持自定义“上一章引用长度” (500/1000/1500/2000字)，实现精准的承上启下逻辑。
- **市场趋势分析**: 集成 Google Search 工具，实时分析各大平台热门题材，提取纯净关键词，避免冗余描述。

### 2. 故事架构师 (Architect)
专注于大纲设计的模块。支持递归式的内容扩展（如：从“书名”生成“分卷”，再生成“章节”，最后生成“场景”）。

### 3. 市场与实验室 (Market & Lab)
通过模拟爬虫数据分析市场热点。实验室功能支持输入任意小说片段，AI 将分析其“爆款因子”、“节奏密度”和“角色弧光”。

### 4. 任务监控台 (Task Monitor)
实时监控所有后台 AI 任务的状态。
- **Token 消耗统计**: 详细展示输入 (Input) 和输出 (Output) 的 Token 数量，帮助优化成本。
- **错误诊断**: 捕获 API 错误详情，区分网络超时、配额不足或内容拦截，并提供原始错误日志。
- **调试模式**: 可查看发送给 AI 的完整 Prompt、System Instruction 和上下文数据。
- **自动重试 (Retry)**: 针对失败任务，提供一键重试功能，并对网络超时进行自动优化。

### 5. 自动化工作流 (Workflow)
实验性功能。允许用户输入一个核心创意，系统自动完成从大纲设计到分章撰写的全自动化流程。

## 🚀 快速开始

1.  **安装依赖**:
    ```bash
    npm install
    ```
2.  **配置环境**:
    复制 `.env.example` 为 `.env`，并填入您的 Google API Key：
    ```bash
    cp .env.example .env
    # 编辑 .env 文件，填入 GEMINI_API_KEY=your_key_here
    ```
3.  **启动开发服务器**:
    ```bash
    npm run dev
    ```
4.  **本地运行注意**:
    本项目已针对本地 Vite 环境进行了适配（修复了 index.html 中的 importmap 冲突）。请确保使用 `npm run dev` 启动。

## 📝 最近更新

### v1.8.5 (2025-12-04)
- **节点扩展功能**:
  - 新增节点扩展功能,可选择任意思维导图节点进行扩展
  - 以选中节点为根,生成更多子节点,不影响其他结构
  - 扩展界面仿照重新生成思维导图,支持:
    - 扩展想法输入
    - 约束条件设置
    - 风格提示词选择
    - 参考上下文选择(支持AI清洗)
  - 紫粉渐变UI设计,与扩展功能主题匹配
  - 支持渐进式丰富思维导图内容

### v1.8.4 (2025-12-04)
- **上下文缓存用户控制**:
  - 新增缓存开关,用户可手动控制是否启用上下文缓存
  - 在 Dashboard 的 AI 资源卡片中一键开关
  - 缓存开启: 蓝青渐变背景,💾 节省Token 标签
  - 缓存关闭: 灰色背景,🔄 实时清洗 标签
  - 设置自动保存,刷新页面后保持状态
  - 开启缓存可显著提升速度并节省 Token 消耗
  - 关闭缓存确保每次使用最新的清洗逻辑

### v1.8.3 (2025-12-04)
- **上下文清洗 (Context Scrubbing) 增强**:
  - 修复思维导图重绘时压缩率为 0% 的问题
  - 新增模型自动回退机制: 2.5 Flash 失败时自动尝试 Lite 模型
  - 增强 JSON 解析容错能力,防止因格式错误导致清洗失败
  - 添加详细的调试日志,便于排查清洗失败原因
  - 优化空结果处理,防止数据丢失

### v1.8.2 (2025-12-04)
- **Fast 模式功能**:
  - 新增 Fast 模式,通过优化 AI 参数提升响应速度 20-30%
  - 在 Dashboard 的 AI 资源卡片中一键切换模式
  - 支持所有 Gemini 系列模型
  - 智能参数调整: 降低 temperature、topP、topK
  - 根据任务类型自动优化(简单任务更激进)
  - 渐变色按钮清晰指示当前模式状态
  - 不损失核心信息,仅优化生成策略

- **用户体验优化**:
  - Fast 模式: ⚡ 快速 (紫粉渐变背景)
  - 正常模式: 🎯 精准 (浅灰背景)
  - 模式状态自动保存,下次访问保持
  - 仅支持 Fast 模式的模型显示切换按钮

### v1.8.1 (2025-12-04)
- **任务监控器优化**:
  - 移除自动弹出逻辑,任务监控器现在默认隐藏
  - 仅在用户手动点击时展开,不干扰创作流程
  - 提升用户体验,减少界面干扰

- **思维导图生成增强**:
  - 增强JSON解析逻辑,添加详细调试日志
  - 改进智能解包机制,更准确提取children数组
  - 强化提示词要求,生成3-4层深度的层级结构
  - 要求将description中的内容拆分成子节点
  - 为各类型思维导图添加多层级展开示例
  - 优化力量体系、世界观、角色、章节、事件等专项要求

- **调试能力提升**:
  - 添加详细的控制台日志,便于排查生成问题
  - 显示原始响应、解析过程、children数量等关键信息
  - 错误时输出完整的原始响应,便于诊断

### v1.8.0 (2025-12-03)
- **扩展模型支持**:
  - 新增 Gemini 2.5 Pro 模型支持,提供更强的推理能力
  - 新增 Gemini 2.0 Flash 实验版,体验最新功能
  - 集成阿里千问系列模型 (Turbo/Plus/Max)
  - 集成字节豆包系列模型 (Lite 4K/Pro 32K)
  - 为所有新模型添加完整的中英文国际化支持

- **模型健康检测功能**:
  - 新增模型健康检测器组件,可手动测试各个模型的可用性
  - 实时测量网络延迟,提供延迟等级评估(优秀/良好/一般/较慢)
  - 支持单个模型测试和批量测试
  - 按提供商(Google/阿里/字节)分组显示模型
  - 在管理后台的"模型配置"标签中可访问
  - 显示详细的错误信息,便于排查API配置问题

- **用户体验优化**:
  - 模型选择界面现在显示更详细的模型描述
  - 健康检测结果包含响应预览,验证模型工作状态
  - 添加测试进度显示,批量测试时可查看当前进度

### v1.8.0 (2025-12-05)
- **大幅增强思维导图内容质量**:
  - 力量体系: 要求8-12个等级,每个等级6个子属性(修炼条件、能力特征、突破方法、战力表现、稀有能力、修炼难度)
  - 世界观: 要求5个一级节点(地理、历史、势力、法则、特色设定),每个节点4-6个子节点
  - 章节细纲: 要求15-25个章节,每章8个子节点(标题、场景、剧情、冲突、转折、角色、悬念、爽点)
  - 角色档案: 要求每个角色8个子节点(基本信息、性格、背景、关系、能力、动机、成长、魅力)
  - 事件时间轴: 要求12-20个事件,每个事件7个子节点(概述、起因、经过、结果、影响、看点、细节)
  - 添加精彩程度要求: 起承转合、爽点设计、悬念设置、情感共鸣
  - 添加内容丰富度要求: 避免套路化、独特设定、复杂关系网
  - 添加具体示例: 每种导图类型都有详细的精彩示例

- **提示词完全统一管理**:
  - ✅ 创建提示词配置管理系统(promptConfig.ts)
  - ✅ 支持提示词的加载、保存、导入、导出
  - ✅ 提示词存储在localStorage,可持久化
  - ✅ 创建提示词管理界面(PromptManager.tsx)
  - ✅ 管理员可以查看、编辑所有提示词配置
  - ✅ 支持按分类筛选和搜索提示词
  - ✅ 支持重置为默认配置
  - ✅ 支持导出/导入JSON配置文件
  - ✅ 集成到管理员界面的"提示词管理"标签页
  - ✅ **完成geminiService.ts的提示词迁移**
  - ✅ **删除所有硬编码的提示词**
  - ✅ **所有导图类型提示词统一从promptConfig获取**
  - 包含9个导图类型配置: 基础结构、力量体系、世界观、章节细纲、角色档案、事件时间轴、任务状态、伏笔锚点、宏观结构
  - 代码量减少约300行,可维护性大幅提升
  - 管理员可通过界面实时调整所有提示词,无需修改代码

- **修复智能清洗压缩率显示bug**:
  - 重构`optimizeContextWithAI`函数,返回包含状态的`OptimizationResult`对象
  - 明确区分"优化成功"和"优化失败"两种状态
  - **新增失败原因显示**: 当智能清洗未生效时,会显示具体原因(如"内容过短"、"AI提取失败"、"解析错误"等)
  - 修复压缩率计算逻辑,确保准确反映实际压缩效果
  - 增强TaskMonitor调试界面,在Comparison视图中显示优化状态、压缩率和详细原因
  - 优化失败时会明确提示"Optimization Failed",避免误导用户
  - 增强调试日志,输出详细的AI响应和错误信息
  - **默认开启Auto-Run**: 任务不再需要手动点击"Run"按钮,提供流畅的用户体验(高级用户可在TaskMonitor中关闭)
  - **优化进度显示**: 使用emoji图标清晰标识智能清洗的各个阶段(🔄清洗中 → ✅完成 / ⚠️失败)
  - 在暂停前明确显示"✅ 上下文准备完成，等待确认..."，确保用户知道清洗已完成
  
- **增强思维导图JSON解析**:
  - 优化智能解包逻辑(v6),支持更多AI返回格式
  - 支持直接返回children数组的情况: `[{name: "node1"}, {name: "node2"}]`
  - 支持单根节点数组包装: `[{name: "root", children: [...]}]`
  - **新增中文字段名支持**: 自动识别并转换`事件名词`、`名称`、`节点名`等中文字段为标准`name`字段
  - **完整保留所有字段内容**: 将`欲望`、`阻碍`、`行动`、`结果`、`意外`、`转折`、`结局`等字段合并到`description`中
  - 同时保留原始中文字段作为自定义属性,便于后续处理
  - 添加详细的调试日志,便于诊断解析失败的原因
  - 修复"AI返回数据但显示为空"的问题

### v1.7.9 (2025-12-03)
- **优化思维导图生成**:
  - 强化结构化提示词,明确要求AI将内容拆分成多个子节点
  - 禁止在description中堆砌大量内容,每个节点description限制在50-100字
  - 为每种导图类型添加专项要求(力量体系、世界观、章节细纲等)
  - 要求至少创建3-8个子节点,避免内容集中在单个节点
  - 添加正确/错误示例对比,提高AI理解准确性

- **统一常量和提示词管理**:
  - 创建 `constants.ts` 统一管理所有固定文字、UI文案、配置项
  - 创建 `prompts.ts` 集中管理所有AI提示词模板
  - 将 `geminiService.ts` 中的所有硬编码提示词迁移到 `prompts.ts`
  - 添加提示词版本控制系统(v1.0.0)
  - 添加提示词性能追踪接口
  - 添加提示词使用示例文档
  - 便于维护、优化和国际化扩展
  - 提高代码可读性和可维护性
  - 支持A/B测试和性能监控

- **增强任务监控台调试信息**:
  - 市场趋势分析任务现在完整显示上下文、token使用数、请求详情和返回结果
  - AI任务失败时也会显示完整的请求参数信息,便于问题排查
  - 优化错误信息展示,包含详细的错误原因和API调用详情

### v1.7.8 (2025-12-03)
- **优化市场趋势分析**:
  - 强化提示词约束，明确要求AI只输出纯净关键词，不要描述性文字
  - 在服务端和客户端双层实现关键词清洗逻辑，去除"根据搜索到的信息"等冗余前缀
  - 支持去除序号、引号、markdown格式等干扰字符
  - 智能提取关键词，处理多种边缘情况
  - 添加详细的日志记录，便于调试和优化

---
**开发者**: InkFlow Team
**版本**: v1.8.5
**许可证**: MIT