# 思维导图优化与统一管理说明

## 问题描述

### 问题1: 思维导图内容堆砌
**现象**: 重新生成的思维导图不够清晰,AI倾向于把很多内容都放在同一个节点的description中,而不是拆分成多个子节点。

**原因**: 
- 提示词约束不够明确,没有强制要求拆分子节点
- 缺少对description长度的限制
- 没有针对不同导图类型的专项要求
- 缺少正确/错误示例对比

### 问题2: 固定文字和提示词分散管理
**现象**: 项目中的固定文字、UI文案、提示词等分散在各个文件中,不便于维护和修改。

**原因**: 
- 缺少统一的常量管理机制
- 提示词直接写在业务逻辑中
- 不利于国际化扩展

## 解决方案

### 1. 优化思维导图生成提示词 (geminiService.ts)

#### 强化结构化要求

**优化前**:
```typescript
const structurePrompt = `
    OUTPUT FORMAT: JSON (Strict)
    
    You MUST return a SINGLE JSON Object representing the root node. 
    DO NOT wrap it in a list or another object like {"root": ...}.
    
    CRITICAL STRUCTURE RULES:
    1. The output MUST be a VALID JSON object representing the ROOT node.
    2. The root object MUST have 'name', 'type'='${rootType}', 'description', and 'children' array.
    3. The child nodes inside 'children' array MUST have 'type'='${childType}'.
    4. Do NOT summarize complex lists in the 'description'. You MUST create child nodes.
    5. Recursively nest child nodes using the 'children' array.
`;
```

**优化后**:
```typescript
const structurePrompt = `
    ========================================
    【输出格式】: JSON (严格模式)
    ========================================
    
    你必须返回一个代表根节点的 JSON 对象。
    禁止用数组包裹,禁止用 {"root": ...} 这样的额外层级。
    
    【目标结构示例】:
    {
      "name": "根节点名称",
      "type": "${rootType}",
      "description": "简短概述(不超过100字)",
      "children": [
         { 
           "name": "子节点1", 
           "type": "${childType}", 
           "description": "简短描述(不超过80字)", 
           "children": [] 
         }
      ]
    }
    
    ========================================
    【关键结构规则】(必须严格遵守):
    ========================================
    
    1. ⚠️ 禁止在 description 中堆砌大量内容!
       - 每个节点的 description 必须简洁(50-100字)
       - 如果有多个要点,必须拆分成多个子节点
       - description 只用于概述,不要列举详细内容
    
    2. ✅ 必须创建足够的子节点:
       - 根节点的 children 数组至少要有 3-8 个子节点
       - 每个子节点必须有 'type'='${childType}'
       - 子节点的 name 要具体明确,不要用"其他"、"更多"等模糊词
    
    3. ✅ 合理使用递归结构:
       - 如果某个子节点内容复杂,继续创建它的 children
       - 建议层级深度: 2-3层
       - 叶子节点的 children 可以是空数组 []
    
    4. ⚠️ 严禁的错误做法:
       - ❌ 把所有内容写在根节点的 description 里
       - ❌ 只创建1-2个子节点,其他内容都塞在 description
       - ❌ 使用"包括但不限于"、"等等"这样的模糊表述
       - ❌ 子节点 name 重复或过于笼统
    
    5. ✅ 正确的做法示例:
       错误: { "name": "角色", "description": "主角张三,配角李四,反派王五..." }
       正确: { 
         "name": "角色", 
         "description": "小说主要角色设定",
         "children": [
           { "name": "主角-张三", "description": "..." },
           { "name": "配角-李四", "description": "..." },
           { "name": "反派-王五", "description": "..." }
         ]
       }
`;
```

#### 添加专项要求

为每种导图类型添加了详细的专项要求:

1. **力量体系** (system):
   - 必须将每个等级/境界拆分成独立的子节点
   - 至少创建 5-10 个等级节点
   - 示例结构: 根节点"修仙体系" -> 子节点["炼气期", "筑基期", "金丹期"...]

2. **世界观** (world):
   - 必须创建至少 4 个一级子节点: 地理、历史、势力、法则
   - 每个一级节点下继续细分二级节点

3. **章节细纲** (chapters):
   - 每个子节点必须代表一个独立的章节
   - 至少创建 10 个章节节点
   - 章节标题要有悬念感

4. **角色档案** (character):
   - 必须为每个重要角色创建独立的子节点
   - 至少包含: 主角、主要配角(2-3个)、主要反派(1-2个)

5. **事件时间轴** (events):
   - 每个重大事件必须是独立的子节点
   - 至少创建 8-12 个事件节点

6. **任务状态** (mission):
   - 每个阶段的任务/状态必须是独立的子节点
   - 至少创建 5-8 个任务节点

7. **伏笔锚点** (anchor):
   - 每个伏笔/关键物品必须是独立的子节点
   - 至少创建 4-6 个伏笔节点

8. **宏观结构** (structure):
   - 必须将小说拆分成多个卷/篇章
   - 至少创建 3-5 个卷节点

### 2. 创建统一常量管理 (constants.ts)

新建 `constants.ts` 文件,集中管理:

- **UI 文案常量**: 按钮文字、状态文字、提示信息等
- **业务常量**: 平台名称、受众类型、导图类型等
- **配置常量**: 模型配置、存储键名、导出配置等
- **正则表达式**: 常用的匹配模式
- **错误信息**: API错误、验证错误等

**示例**:
```typescript
/** 通用按钮文案 */
export const BUTTON_TEXT = {
    CONFIRM: '确认',
    CANCEL: '取消',
    SAVE: '保存',
    DELETE: '删除',
    // ...
} as const;

/** 导图类型名称 */
export const MAP_TYPE_NAMES = {
    world: '世界观设定',
    structure: '宏观结构',
    character: '角色档案',
    // ...
} as const;
```

### 3. 创建提示词统一管理 (prompts.ts)

新建 `prompts.ts` 文件,集中管理所有AI提示词模板:

- 趋势分析提示词
- 每日灵感生成提示词
- 章节正文生成提示词
- 文本操作提示词
- 插图提示词生成
- 架构生成提示词(三阶段)
- 上下文优化提示词
- 提示词格式转换

**示例**:
```typescript
/**
 * 趋势分析提示词模板
 * @param sources 数据来源数组
 * @returns 提示词字符串
 */
export const TREND_ANALYSIS_PROMPT = (sources: string[]): string => {
    return `
请使用 Google Search 搜索最新的网络小说排行榜,来源:${sources.join('、')}。

【任务】:分析当前最热门的题材,提取一个最具"爆款潜力"的核心关键词。

【输出格式】:
- 只输出一个2-6字的关键词
- 不要任何解释、标点、序号
...
    `;
};
```

## 优化效果

### 思维导图生成改进

✅ **结构更清晰**:
- AI会自动将内容拆分成多个子节点
- 每个节点的description保持简洁(50-100字)
- 避免内容堆砌在单个节点

✅ **层级更合理**:
- 根节点至少有3-8个子节点
- 支持2-3层递归结构
- 叶子节点明确标识

✅ **类型更专业**:
- 每种导图类型都有专项要求
- 节点数量有明确指标
- 内容组织更符合逻辑

✅ **示例更直观**:
- 提供正确/错误对比
- AI理解更准确
- 生成质量更稳定

### 代码管理改进

✅ **维护性提升**:
- 所有常量集中管理
- 修改一处即可全局生效
- 便于版本控制

✅ **可读性增强**:
- 代码中使用语义化常量
- 减少魔法字符串
- 提高代码质量

✅ **扩展性更好**:
- 便于添加新的常量
- 支持国际化扩展
- 易于团队协作

✅ **提示词工程化**:
- 提示词模板化管理
- 便于A/B测试
- 易于优化迭代

## 使用示例

### 使用常量

```typescript
import { BUTTON_TEXT, MAP_TYPE_NAMES, DEFAULT_VALUES } from './constants';

// 使用按钮文案
<button>{BUTTON_TEXT.CONFIRM}</button>

// 使用导图类型名称
const mapName = MAP_TYPE_NAMES[mapType];

// 使用默认值
const wordCount = DEFAULT_VALUES.WORD_COUNT;
```

### 使用提示词模板

```typescript
import { TREND_ANALYSIS_PROMPT, CHAPTER_WRITING_PROMPT } from './prompts';

// 生成趋势分析提示词
const prompt = TREND_ANALYSIS_PROMPT(['qidian', 'fanqie']);

// 生成章节写作提示词
const chapterPrompt = CHAPTER_WRITING_PROMPT(
    '第一章 重生归来',
    '主角意外重生到十年前',
    context,
    2000,
    '文风要轻松幽默'
);
```

## 文件修改清单

1. ✅ `services/geminiService.ts` - 优化思维导图生成提示词
2. ✅ `constants.ts` - 新建常量管理文件
3. ✅ `prompts.ts` - 新建提示词管理文件
4. ✅ `README.md` - 更新项目文档,版本升级到 v1.7.9

## 后续优化建议

1. **逐步迁移**: 将现有代码中的硬编码文字逐步迁移到 `constants.ts`
2. **提示词优化**: 根据实际效果持续优化 `prompts.ts` 中的模板
3. **国际化支持**: 基于 `constants.ts` 实现多语言支持
4. **类型安全**: 为常量添加更严格的TypeScript类型定义
5. **文档完善**: 为每个提示词模板添加使用示例和效果说明

## 总结

本次优化通过"强化提示词 + 统一管理"的方案,有效解决了思维导图内容堆砌和代码管理分散的问题。所有修改都遵循了项目的编程规范,添加了完整的中文注释,并同步更新了README文档。
