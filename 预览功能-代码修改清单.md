# 预览功能实施 - 具体代码修改清单

## ✅ 已完成

1. **PreviewModal.tsx** - 预览组件已创建
2. **Studio.tsx** - 已添加import和状态定义

## 🔄 待完成修改

### 1. 添加确认和取消处理函数

在Studio.tsx中，找到状态定义区域后（约第133行），添加以下函数：

```typescript
// 确认替换预览内容
const handleConfirmReplace = () => {
    if (!previewData) return;
    
    if (previewData.type === 'map') {
        // 替换思维导图
        const mapType = selectedMapType; // 需要从previewData中获取或通过其他方式确定
        setArchitecture(prev => ({
            ...prev,
            [mapType]: previewData.newContent as OutlineNode
        }));
        toast.success('思维导图已更新');
    } else if (previewData.type === 'draft') {
        // 添加新章节
        setChapters(prev => [...prev, {
            title: previewData.title.replace('生成章节: ', ''),
            content: previewData.newContent as string
        }]);
        toast.success('章节已添加');
    }
    
    setPreviewData(null);
};

// 取消替换
const handleCancelReplace = () => {
    setPreviewData(null);
    toast.info('已放弃新生成的内容');
};
```

### 2. 修改思维导图重绘逻辑

找到`proceedWithRegen`函数（约第624行），修改生成完成后的逻辑：

**原代码** (约第680行):
```typescript
const newRoot = await regenerateSingleMap(...);

// 直接替换
setArchitecture(prev => ({
    ...prev,
    [selectedMapType]: newRoot
}));
```

**新代码**:
```typescript
const newRoot = await regenerateSingleMap(...);

// 不立即替换，显示预览
setPreviewData({
    type: 'map',
    title: `重绘 ${selectedMapType} 导图`,
    oldContent: architecture[selectedMapType] || { name: '空导图', type: selectedMapType, children: [] },
    newContent: newRoot
});

// 任务完成
updateTaskProgress(taskId, t('process.complete'), 100, '✅ 生成完成，请在预览窗口确认是否替换');
```

### 3. 修改正文草稿生成逻辑

找到`handleGenerateDraft`函数（需要搜索），修改生成完成后的逻辑：

**原代码**:
```typescript
const draft = await generateDraft(...);

// 直接添加
setChapters(prev => [...prev, {
    title: chapterTitle,
    content: draft
}]);
```

**新代码**:
```typescript
const draft = await generateDraft(...);

// 显示预览
setPreviewData({
    type: 'draft',
    title: `生成章节: ${chapterTitle}`,
    oldContent: '', // 新章节没有旧内容
    newContent: draft
});

// 任务完成
updateTaskProgress(taskId, '生成完成', 100, '✅ 生成完成，请在预览窗口确认是否添加');
```

### 4. 在UI中渲染PreviewModal

找到Studio组件的return语句（约第1700行），在最外层div的末尾添加：

```typescript
return (
    <div className="...">
        {/* 原有UI内容 */}
        
        {/* 预览Modal */}
        {previewData && (
            <PreviewModal
                type={previewData.type}
                title={previewData.title}
                oldContent={previewData.oldContent}
                newContent={previewData.newContent}
                isStreaming={false} // 阶段1不使用流式
                onConfirm={handleConfirmReplace}
                onCancel={handleCancelReplace}
            />
        )}
    </div>
);
```

## ⚠️ 注意事项

1. **selectedMapType的作用域**: 在`handleConfirmReplace`中需要访问`selectedMapType`，可能需要将其存储在previewData中
2. **章节标题**: 在草稿预览中，需要保存章节标题以便添加时使用
3. **toast通知**: 确保已导入toast库（可能需要添加import）

## 🔧 改进建议

### 建议1: 扩展previewData结构

```typescript
const [previewData, setPreviewData] = useState<{
    type: 'map' | 'draft';
    title: string;
    oldContent: OutlineNode | string;
    newContent: OutlineNode | string;
    metadata?: {
        mapType?: string; // 用于思维导图
        chapterTitle?: string; // 用于草稿
    };
} | null>(null);
```

### 建议2: 添加toast导入

如果还没有导入toast，在文件顶部添加：

```typescript
import { toast } from 'react-hot-toast'; // 或其他toast库
```

## 📝 测试清单

完成修改后，请测试以下场景：

- [ ] 重绘思维导图 → 显示预览 → 点击"替换" → 内容已更新
- [ ] 重绘思维导图 → 显示预览 → 点击"放弃" → 内容未改变
- [ ] 生成正文草稿 → 显示预览 → 点击"替换" → 章节已添加
- [ ] 生成正文草稿 → 显示预览 → 点击"放弃" → 章节未添加
- [ ] 预览窗口的响应式布局（桌面/移动端）
- [ ] 预览窗口的关闭按钮（ESC键）

## 🚀 下一步

由于这些修改涉及多个位置且需要仔细处理，建议：

**选项A**: 我逐步实施每个修改，每次修改后验证构建
**选项B**: 您根据此文档手动修改，我提供支持
**选项C**: 我创建一个完整的patch文件，您一次性应用

请告诉我您希望采用哪种方式？
