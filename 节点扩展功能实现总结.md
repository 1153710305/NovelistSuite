# 节点扩展功能实现总结

## 📋 功能概述

实现了思维导图节点扩展功能，允许用户选择任意节点，以该节点为根生成更多子节点，而不影响其他节点结构。

### 核心特性

1. **节点选择**: 点击思维导图节点，在详情面板显示"扩展节点"按钮
2. **扩展界面**: 仿照"重新生成思维导图"的模态框设计
3. **灵活配置**: 支持扩展想法、约束条件、风格提示词、上下文选择
4. **增量扩展**: 仅为选中节点添加子节点，保持其他结构不变

---

## 🎯 实现细节

### 1. 状态定义 (`Studio.tsx`)

```typescript
// 扩展节点相关状态
const [showExpandModal, setShowExpandModal] = useState(false);
const [expandingNode, setExpandingNode] = useState<OutlineNode | null>(null);
const [expandIdea, setExpandIdea] = useState('');
const [expandRequirements, setExpandRequirements] = useState('');
const [expandPromptId, setExpandPromptId] = useState('');
const [expandStyleContent, setExpandStyleContent] = useState('');
const [expandContextMapKeys, setExpandContextMapKeys] = useState<string[]>([]);
const [expandOptimizeMapKeys, setExpandOptimizeMapKeys] = useState<string[]>([]);
const [isExpandingNode, setIsExpandingNode] = useState(false);
```

### 2. 类型扩展 (`types.ts`)

```typescript
export interface BackgroundTask {
    type: 'inspiration' | 'story' | 'map_regen' | 'draft' | 'expand_node'; // 新增 expand_node
    // ...
}
```

### 3. 处理函数 (`Studio.tsx`)

**打开模态框**:
```typescript
const handleOpenExpandModal = () => {
    if (!selectedMapNode) return;
    setExpandingNode(selectedMapNode);
    setExpandIdea(`基于 "${selectedMapNode.name}" 扩展更多子节点`);
    setExpandRequirements('');
    setExpandStyleContent('');
    setExpandPromptId('');
    setExpandContextMapKeys([]);
    setExpandOptimizeMapKeys([]);
    setShowExpandModal(true);
};
```

**执行扩展**:
```typescript
const handleExpandNode = async () => {
    // 1. 构建上下文
    // 2. 可选：AI清洗优化
    // 3. 调用 regenerateSingleMap 生成子节点
    // 4. 合并新子节点到原节点
    // 5. 更新树结构和存储
};
```

### 4. UI 组件

**节点详情面板按钮**:
```tsx
<button 
    onClick={handleOpenExpandModal} 
    className="w-full py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded text-xs font-bold"
>
    <GitBranch size={14} />
    扩展节点
</button>
```

**扩展模态框**:
- 显示当前节点信息（名称、描述）
- 扩展想法输入框
- 约束条件输入框
- 风格提示词选择/输入
- 上下文选择（支持AI清洗）
- 取消/开始扩展按钮

---

## 🎨 UI 设计

### 模态框样式
- **头部**: 紫粉渐变背景 (`from-purple-50 to-pink-50`)
- **图标**: `GitBranch` 紫色图标
- **按钮**: 紫粉渐变 (`from-purple-600 to-pink-600`)

### 节点信息卡片
- 紫色背景 (`bg-purple-50`)
- 紫色边框 (`border-purple-200`)
- 显示节点名称和描述预览

---

## 📊 使用流程

1. **选择节点**: 在思维导图中点击目标节点
2. **打开扩展**: 点击详情面板中的"扩展节点"按钮
3. **配置扩展**:
   - 编辑扩展想法
   - 添加约束条件（可选）
   - 选择风格提示词（可选）
   - 选择参考上下文（可选）
4. **开始扩展**: 点击"开始扩展"按钮
5. **查看结果**: 新子节点自动添加到选中节点下

---

## 🔧 技术优势

1. **增量更新**: 仅修改目标节点，不影响整体结构
2. **复用逻辑**: 复用 `regenerateSingleMap` 生成逻辑
3. **灵活上下文**: 支持选择性引用和AI清洗
4. **后台任务**: 通过 TaskMonitor 显示进度

---

## 📁 文件修改清单

1. **`types.ts`**: 添加 `'expand_node'` 任务类型
2. **`pages/Studio.tsx`**:
   - 导入 `GitBranch` 图标
   - 添加扩展节点相关状态 (10个)
   - 添加 `handleOpenExpandModal` 函数
   - 添加 `handleExpandNode` 函数  
   - 添加 `handleToggleExpandKey` 函数
   - 添加 `handleToggleExpandOptimize` 函数
   - 添加节点详情面板"扩展节点"按钮
   - 添加扩展节点模态框 UI

---

## ✅ 功能验证

1. 在思维导图中选择任意节点
2. 点击"扩展节点"按钮，确认模态框正常打开
3. 填写扩展想法，点击"开始扩展"
4. 查看 TaskMonitor 任务进度
5. 完成后验证新子节点已添加到目标节点下
6. 确认其他节点结构未受影响

---

## 🚀 后续优化建议

1. **节点数量控制**: 允许用户指定生成子节点的数量
2. **深度控制**: 支持多级扩展（子节点的子节点）
3. **撤销功能**: 支持撤销最近的扩展操作
4. **预览功能**: 在确认前预览将生成的子节点
5. **批量扩展**: 支持同时扩展多个节点

---

## 📝 版本信息

**版本**: v1.8.5  
**完成时间**: 2025-12-04  
**开发者**: InkFlow Team
