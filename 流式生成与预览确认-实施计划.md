# 流式生成与预览确认功能 - 实施计划

## 📋 需求概述

在重新生成思维导图和正文草稿时：
1. 使用流式API实时显示生成进度
2. 生成完成后显示预览，不立即替换原内容
3. 提供"替换"和"放弃"按钮供用户选择
4. 只有用户确认后才替换原有内容

## 🎯 涉及的功能点

### 1. 思维导图重绘 (Map Regeneration)
- 文件: `pages/Studio.tsx` - `proceedWithRegen` 函数
- 当前: 直接替换 `architecture[selectedMapType]`
- 改进: 先存储到临时变量，等待用户确认

### 2. 正文草稿生成 (Draft Generation)
- 文件: `pages/Studio.tsx` - `handleGenerateDraft` 函数
- 当前: 直接添加到 `chapters` 数组
- 改进: 先存储到临时变量，等待用户确认

## 🔧 技术实施方案

### 方案A: 使用Modal对话框（推荐）

**优点**:
- UI清晰，用户体验好
- 可以并排显示新旧内容对比
- 易于实现和维护

**实施步骤**:

1. **修改 `geminiService.ts`**:
   - 添加流式API支持
   - `regenerateSingleMap` 支持 `onStream` 回调
   - `generateDraft` 支持流式输出

2. **修改 `Studio.tsx`**:
   - 添加预览状态管理
   - 生成完成后显示确认对话框
   - 实现"替换"和"放弃"逻辑

3. **创建 `PreviewModal.tsx` 组件**:
   - 显示新旧内容对比
   - 提供"替换"和"放弃"按钮
   - 支持思维导图和正文两种预览模式

4. **更新 `TaskMonitor.tsx`**:
   - 显示流式生成进度
   - 实时更新生成内容

### 方案B: 使用侧边栏预览

**优点**:
- 不遮挡主界面
- 可以同时查看原内容和新内容

**缺点**:
- 需要更多UI调整
- 实施复杂度较高

## 📝 详细实施步骤（方案A）

### Step 1: 添加流式API支持

**文件**: `services/geminiService.ts`

```typescript
// 添加流式生成函数
export const regenerateSingleMapStream = async (
  mapType: string,
  prompt: string,
  context: string,
  systemInstruction: string,
  onStream?: (chunk: string) => void,
  onUpdate?: (...) => void
): Promise<OutlineNode> => {
  // 使用 streamGenerateContent 替代 generateContent
  const stream = await ai.models.streamGenerateContent({...});
  
  let fullText = '';
  for await (const chunk of stream) {
    const text = chunk.text || '';
    fullText += text;
    if (onStream) onStream(text);
  }
  
  // 解析完整文本
  return parseResult(fullText);
};
```

### Step 2: 创建预览Modal组件

**文件**: `components/PreviewModal.tsx`

```typescript
interface PreviewModalProps {
  type: 'map' | 'draft';
  oldContent: any;
  newContent: any;
  onConfirm: () => void;
  onCancel: () => void;
}

export const PreviewModal: React.FC<PreviewModalProps> = ({...}) => {
  return (
    <div className="modal">
      <div className="preview-container">
        <div className="old-content">
          <h3>原内容</h3>
          {/* 显示原内容 */}
        </div>
        <div className="new-content">
          <h3>新生成内容</h3>
          {/* 显示新内容 */}
        </div>
      </div>
      <div className="actions">
        <button onClick={onCancel}>放弃</button>
        <button onClick={onConfirm}>替换</button>
      </div>
    </div>
  );
};
```

### Step 3: 修改Studio.tsx

**文件**: `pages/Studio.tsx`

```typescript
// 添加预览状态
const [previewData, setPreviewData] = useState<{
  type: 'map' | 'draft';
  oldContent: any;
  newContent: any;
} | null>(null);

// 修改 proceedWithRegen
const proceedWithRegen = async () => {
  // ... 生成逻辑
  
  const newMap = await regenerateSingleMapStream(
    selectedMapType,
    prompt,
    context,
    systemInstruction,
    (chunk) => {
      // 实时更新预览
      updateTaskProgress(taskId, '生成中', progress, chunk);
    }
  );
  
  // 不立即替换，而是显示预览
  setPreviewData({
    type: 'map',
    oldContent: architecture[selectedMapType],
    newContent: newMap
  });
};

// 确认替换
const handleConfirmReplace = () => {
  if (previewData?.type === 'map') {
    // 替换思维导图
    setArchitecture(prev => ({
      ...prev,
      [selectedMapType]: previewData.newContent
    }));
  }
  setPreviewData(null);
};

// 放弃
const handleCancelReplace = () => {
  setPreviewData(null);
};
```

### Step 4: 更新UI

在 `Studio.tsx` 的 render 中添加：

```typescript
{previewData && (
  <PreviewModal
    type={previewData.type}
    oldContent={previewData.oldContent}
    newContent={previewData.newContent}
    onConfirm={handleConfirmReplace}
    onCancel={handleCancelReplace}
  />
)}
```

## ⚠️ 注意事项

1. **流式API限制**: 
   - Gemini API 的流式输出可能有延迟
   - 需要处理网络中断的情况

2. **状态管理**:
   - 预览数据需要妥善管理
   - 避免内存泄漏

3. **用户体验**:
   - 生成过程中应禁用其他操作
   - 提供清晰的进度指示

4. **错误处理**:
   - 流式生成失败时的回退机制
   - 用户取消生成的处理

## 🚀 实施优先级

1. **高优先级**: 思维导图重绘的流式预览
2. **中优先级**: 正文草稿的流式预览
3. **低优先级**: 其他生成功能的流式支持

## 📊 预估工作量

- 流式API集成: 2-3小时
- PreviewModal组件: 1-2小时
- Studio.tsx改造: 2-3小时
- 测试和调试: 1-2小时

**总计**: 6-10小时

## ❓ 待确认问题

1. 是否需要保存生成历史（允许在多个版本间切换）？
2. 预览Modal的样式偏好（并排对比 vs 标签切换）？
3. 是否需要支持"部分替换"（只替换某些子节点）？
