# 流式生成与预览确认 - 简化实施方案

## 当前状态

由于流式API的集成涉及较大改动，我建议采用**渐进式实施**策略：

### 阶段1: 基础预览功能（无流式）⭐ 推荐先实施

**目标**: 先实现预览确认功能，暂不使用流式API

**优点**:
- 实施简单，风险低
- 用户立即获得"预览-确认"的UX改进
- 为后续流式API集成打好基础

**实施步骤**:

1. ✅ **PreviewModal组件** - 已完成
2. **修改Studio.tsx** - 添加预览状态管理
3. **修改生成逻辑** - 先存储到临时变量，等待确认

### 阶段2: 流式API集成（后续优化）

**目标**: 在预览窗口中实时显示生成进度

**挑战**:
- Gemini SDK的流式API接口需要适配
- 状态管理更复杂
- 需要处理流式中断和错误

---

## 阶段1详细实施

### 1. 在Studio.tsx中添加预览状态

```typescript
// 预览数据状态
interface PreviewData {
    type: 'map' | 'draft';
    title: string;
    oldContent: OutlineNode | string;
    newContent: OutlineNode | string;
}

const [previewData, setPreviewData] = useState<PreviewData | null>(null);
const [isGenerating, setIsGenerating] = useState(false);
```

### 2. 修改思维导图重绘逻辑

**原逻辑**:
```typescript
const newRoot = await regenerateSingleMap(...);
setArchitecture(prev => ({
    ...prev,
    [selectedMapType]: newRoot
}));
```

**新逻辑**:
```typescript
const newRoot = await regenerateSingleMap(...);

// 不立即替换，而是显示预览
setPreviewData({
    type: 'map',
    title: `重绘 ${selectedMapType} 导图`,
    oldContent: architecture[selectedMapType] || createEmptyNode(),
    newContent: newRoot
});
```

### 3. 修改正文草稿生成逻辑

**原逻辑**:
```typescript
const draft = await generateDraft(...);
setChapters(prev => [...prev, { title, content: draft }]);
```

**新逻辑**:
```typescript
const draft = await generateDraft(...);

// 显示预览
setPreviewData({
    type: 'draft',
    title: `生成章节: ${title}`,
    oldContent: '', // 新章节没有旧内容
    newContent: draft
});
```

### 4. 实现确认和取消逻辑

```typescript
// 确认替换
const handleConfirmReplace = () => {
    if (!previewData) return;
    
    if (previewData.type === 'map') {
        // 替换思维导图
        setArchitecture(prev => ({
            ...prev,
            [selectedMapType]: previewData.newContent as OutlineNode
        }));
        toast.success('思维导图已更新');
    } else if (previewData.type === 'draft') {
        // 添加新章节
        setChapters(prev => [...prev, {
            title: currentChapterTitle,
            content: previewData.newContent as string
        }]);
        toast.success('章节已添加');
    }
    
    setPreviewData(null);
};

// 取消
const handleCancelReplace = () => {
    setPreviewData(null);
    toast.info('已放弃新生成的内容');
};
```

### 5. 在UI中渲染PreviewModal

```typescript
return (
    <div>
        {/* 原有UI */}
        
        {/* 预览Modal */}
        {previewData && (
            <PreviewModal
                type={previewData.type}
                title={previewData.title}
                oldContent={previewData.oldContent}
                newContent={previewData.newContent}
                isStreaming={false} // 阶段1不使用流式
                onConfirm={handleConfirmReplace}
                onCancel={handleCancelReplace}
            />
        )}
    </div>
);
```

---

## 需要修改的具体位置

### Studio.tsx

1. **Line ~119**: 添加import
```typescript
import { PreviewModal } from '../components/PreviewModal';
```

2. **Line ~150**: 添加状态
```typescript
const [previewData, setPreviewData] = useState<{
    type: 'map' | 'draft';
    title: string;
    oldContent: OutlineNode | string;
    newContent: OutlineNode | string;
} | null>(null);
```

3. **Line ~670** (proceedWithRegen函数): 修改替换逻辑
4. **Line ~750** (handleGenerateDraft函数): 修改添加逻辑
5. **Line ~1700** (render部分): 添加PreviewModal

---

## 下一步

请确认是否先实施**阶段1**（基础预览功能），还是直接实施**完整的流式API版本**？

- **选项A**: 先实施阶段1，快速上线预览功能 ⭐ 推荐
- **选项B**: 直接实施完整流式版本（需要更多时间）
