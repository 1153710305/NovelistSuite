# 任务监控台调试信息优化说明

## 问题描述

### 问题1: 市场趋势分析任务调试信息不完整
**现象**: 在任务监控台查看市场趋势分析任务时,缺少以下信息:
- 上下文(context)信息
- Token使用数(metrics)
- 请求详细信息(apiPayload)
- 返回结果

### 问题2: AI任务失败时缺少请求参数
**现象**: 当AI任务失败时,任务监控台只显示错误信息,但没有显示失败时的请求参数,导致难以排查问题。

## 解决方案

### 1. 优化 `analyzeTrendKeywords` 函数 (geminiService.ts)

#### 添加初始调试信息

**优化前**:
```typescript
if (onDebug) {
    onDebug({
        prompt: displayPrompt,
        model: model,
        systemInstruction: systemInstruction || PromptService.getGlobalSystemInstruction(lang),
        context: `Grounding Search: ${platformNames} ${genderStr}`,
        sourceData: "Requesting Google Search..."
    });
}
```

**优化后**:
```typescript
const finalSystemInstruction = systemInstruction || PromptService.getGlobalSystemInstruction(lang);

// 初始调试信息
if (onDebug) {
    onDebug({
        prompt: displayPrompt,
        model: model,
        systemInstruction: finalSystemInstruction,
        context: `Grounding Search: ${platformNames} ${genderStr}`,
        sourceData: "Requesting Google Search..."
    });
}
```

**改进点**:
- 提取 `finalSystemInstruction` 为变量,避免重复计算
- 确保所有地方使用相同的系统指令

#### 完善成功时的调试信息

**优化后**:
```typescript
// Extract metrics
const metrics = extractMetrics(response, model, startTime);

// Pass complete API payload and metrics after response
if (onDebug) {
    onDebug({
        apiPayload: {
            request: `System: ${finalSystemInstruction}\n\nUser: ${prompt}`,
            response: response.text || ""
        },
        metrics: metrics
    });
}
```

**包含信息**:
- ✅ **apiPayload.request**: 完整的请求内容(系统指令 + 用户提示词)
- ✅ **apiPayload.response**: AI返回的原始响应
- ✅ **metrics**: Token使用统计(输入、输出、总计、延迟)

#### 添加失败时的调试信息

**优化前**:
```typescript
} catch (error) {
    console.error("Trend Analysis Failed", error);
    return "玄幻";
}
```

**优化后**:
```typescript
} catch (error: any) {
    console.error("Trend Analysis Failed", error);
    
    // 失败时也传递调试信息
    if (onDebug) {
        const errorDetails = getErrorDetails(error);
        onDebug({
            error: true,
            errorMessage: errorDetails,
            apiPayload: {
                request: `System: ${finalSystemInstruction}\n\nUser: ${prompt}`,
                response: `Error: ${errorDetails}`
            },
            // 尝试提取部分指标(如果有)
            metrics: error.response ? extractMetrics(error.response, model, Date.now()) : undefined
        });
    }
    
    return "玄幻";
}
```

**包含信息**:
- ✅ **error**: 标记为错误状态
- ✅ **errorMessage**: 详细的错误信息
- ✅ **apiPayload.request**: 失败时的完整请求参数
- ✅ **apiPayload.response**: 错误详情
- ✅ **metrics**: 如果有响应,尝试提取指标

### 2. 调试信息流转过程

#### 数据流向

```
analyzeTrendKeywords (geminiService.ts)
    ↓ onDebug回调
handleAnalyzeTrend (Studio.tsx)
    ↓ updateTaskProgress
updateTaskProgress (AppContext.tsx)
    ↓ 更新任务状态
TaskMonitor (TaskMonitor.tsx)
    ↓ 显示调试信息
```

#### Studio.tsx 中的调用

```typescript
const trend = await analyzeTrendKeywords(selectedSources, targetAudience, lang, model, globalPersona, (debugInfo) => {
    // 如果 debugInfo 包含 metrics,传递给 updateTaskProgress
    const metrics = debugInfo.metrics;
    updateTaskProgress(taskId, t('process.analyzingTrend'), 50, undefined, metrics, debugInfo);
});
```

**关键点**:
- 通过 `onDebug` 回调接收调试信息
- 提取 `metrics` 并传递给 `updateTaskProgress`
- 完整的 `debugInfo` 也传递给任务系统

#### AppContext.tsx 中的处理

```typescript
const updateTaskProgress = (taskId: string, stage: string, progress: number, logMessage?: string, metrics?: AIMetrics, debugInfo?: BackgroundTask['debugInfo']) => {
    // 如果有指标数据,更新全局统计
    if (metrics) {
        setUsageStats(prev => {
            // 更新统计...
        });
    }
    
    setActiveTasks(prev => prev.map(task => {
        if (task.id !== taskId || task.status === 'cancelled') return task;
        
        // 累加指标
        let newMetrics = task.metrics;
        if (metrics) {
            newMetrics = {
                model: metrics.model,
                inputTokens: (task.metrics?.inputTokens || 0) + metrics.inputTokens,
                outputTokens: (task.metrics?.outputTokens || 0) + metrics.outputTokens,
                totalTokens: (task.metrics?.totalTokens || 0) + metrics.totalTokens,
                latency: (task.metrics?.latency || 0) + metrics.latency
            };
        }
        
        const updatedLogs = logMessage ? [...task.logs, { timestamp: Date.now(), message: logMessage }] : task.logs;
        // 合并调试信息
        const updatedDebugInfo = debugInfo ? { ...task.debugInfo, ...debugInfo } : task.debugInfo;
        return { ...task, currentStage: stage, progress, logs: updatedLogs, metrics: newMetrics, debugInfo: updatedDebugInfo };
    }));
};
```

**关键点**:
- 累加 metrics 到任务记录
- 合并 debugInfo 到任务记录
- 更新全局使用统计

### 3. 任务监控台显示

TaskMonitor.tsx 会自动显示任务的 `debugInfo`,包括:

1. **Prompt 标签页**:
   - 显示 `debugInfo.prompt`
   - 显示 `debugInfo.systemInstruction`
   - 显示 `debugInfo.context`

2. **API 标签页**:
   - 显示 `debugInfo.apiPayload.request`
   - 显示 `debugInfo.apiPayload.response`
   - 显示 `debugInfo.metrics` (Token统计)

3. **错误状态**:
   - 如果 `debugInfo.error === true`,会特别标注
   - 显示 `debugInfo.errorMessage`
   - 仍然显示请求参数,便于排查

## 优化效果

### 成功情况

✅ **完整的调试信息**:
- 可以看到完整的系统指令
- 可以看到用户提示词
- 可以看到上下文信息(Grounding Search)
- 可以看到AI返回的原始响应
- 可以看到Token使用统计

✅ **便于优化**:
- 分析哪些提示词效果好
- 了解Token消耗情况
- 对比不同模型的表现

### 失败情况

✅ **完整的错误信息**:
- 可以看到失败时的请求参数
- 可以看到详细的错误原因
- 可以判断是网络问题、配额问题还是内容问题

✅ **便于排查**:
- 重现问题时的完整上下文
- 快速定位问题根源
- 决定是否需要重试或调整参数

## 示例

### 成功时的调试信息

```json
{
  "prompt": "请使用 Google Search 搜索最新的\"起点中文网、番茄小说 男频 小说排行榜\"...",
  "model": "gemini-2.5-flash",
  "systemInstruction": "你是由 InkFlow AI 驱动的资深网文主编...",
  "context": "Grounding Search: 起点中文网、番茄小说 男频",
  "sourceData": "Requesting Google Search...",
  "apiPayload": {
    "request": "System: 你是由 InkFlow AI 驱动的资深网文主编...\n\nUser: 请使用 Google Search 搜索...",
    "response": "赛博修仙"
  },
  "metrics": {
    "model": "gemini-2.5-flash",
    "inputTokens": 245,
    "outputTokens": 12,
    "totalTokens": 257,
    "latency": 3542
  }
}
```

### 失败时的调试信息

```json
{
  "prompt": "请使用 Google Search 搜索最新的\"起点中文网、番茄小说 男频 小说排行榜\"...",
  "model": "gemini-2.5-flash",
  "systemInstruction": "你是由 InkFlow AI 驱动的资深网文主编...",
  "context": "Grounding Search: 起点中文网、番茄小说 男频",
  "error": true,
  "errorMessage": "⚠️ API 配额耗尽 (429)。请检查您的 API Key 额度...",
  "apiPayload": {
    "request": "System: 你是由 InkFlow AI 驱动的资深网文主编...\n\nUser: 请使用 Google Search 搜索...",
    "response": "Error: ⚠️ API 配额耗尽 (429)..."
  }
}
```

## 文件修改清单

1. ✅ `services/geminiService.ts` - 优化 `analyzeTrendKeywords` 函数,添加失败时的调试信息
2. ✅ `README.md` - 更新项目文档,记录优化内容

## 后续建议

1. **扩展到其他函数**: 将相同的错误处理模式应用到其他AI调用函数
2. **结构化错误信息**: 定义统一的错误信息格式
3. **错误分类**: 区分不同类型的错误(网络、配额、内容安全等)
4. **自动重试建议**: 根据错误类型提供重试建议

## 总结

本次优化确保了任务监控台能够完整显示市场趋势分析任务的所有调试信息,包括成功和失败两种情况。这大大提高了问题排查的效率,也便于用户了解AI的工作过程和Token消耗情况。
