# 前端服务层迁移指南

## 📋 概述

为了实现前后端分离，我们创建了 `geminiServiceAdapter.ts` 作为过渡方案。

## 🔄 迁移策略

### 当前状态
- ✅ 后端已实现：`generateDailyStories`, `generateNovelArchitecture`, `generateChapterContent`
- ⏳ 前端保留：`regenerateSingleMap`, `expandNode` 等其他功能

### 适配器模式
`geminiServiceAdapter.ts` 提供智能路由：
- 已迁移的功能 → 调用后端 API
- 未迁移的功能 → 调用前端 geminiService
- 后端失败时 → 自动回退到前端

## 🛠️ 迁移步骤

### 步骤 1: 更新导入语句

**需要修改的文件**:
1. `pages/Workflow.tsx`
2. `pages/Architect.tsx`
3. `pages/Studio.tsx`
4. `pages/Chat.tsx`（暂不修改，未迁移）
5. `pages/CoverStudio.tsx`（暂不修改，未迁移）

**修改示例**:

**之前**:
```typescript
import { 
    generateNovelArchitecture, 
    generateChapterContent 
} from '../services/geminiService';
```

**之后**:
```typescript
import { 
    generateNovelArchitecture, 
    generateChapterContent 
} from '../services/geminiServiceAdapter';
```

### 步骤 2: 配置环境变量

在 `.env` 文件中添加：
```bash
# 后端服务器地址
NEXT_PUBLIC_BACKEND_URL=http://localhost:3001

# 是否使用后端 API（可选，默认 true）
NEXT_PUBLIC_USE_BACKEND=true
```

### 步骤 3: 启动后端服务器

```bash
cd server
GEMINI_API_KEYS=your-key-1,your-key-2 node src/index.js
```

### 步骤 4: 测试功能

1. 启动前端：`npm run dev`
2. 测试每日灵感生成
3. 测试小说架构生成
4. 测试章节内容生成

## 🔍 验证方法

### 检查是否使用后端

打开浏览器控制台，查看日志：
```
[GeminiAdapter] 模式: 后端API
```

或者：
```
[GeminiAdapter] 模式: 前端直连
```

### 检查后端调用

在 Network 标签中，应该看到对 `http://localhost:3001/api/generate/*` 的请求。

## 🚨 故障排除

### 问题 1: 后端连接失败

**症状**: 控制台显示 "后端调用失败，回退到前端"

**解决方案**:
1. 确认后端服务器已启动
2. 检查 `NEXT_PUBLIC_BACKEND_URL` 配置
3. 检查后端日志

### 问题 2: CORS 错误

**症状**: 浏览器报 CORS 错误

**解决方案**:
后端已配置 CORS，如果仍有问题，检查 `server/src/index.js` 中的 CORS 配置。

### 问题 3: 功能异常

**症状**: 生成的内容格式不对

**解决方案**:
1. 检查后端日志
2. 查看任务详情：`GET /api/tasks/{taskId}`
3. 查看任务日志：`GET /api/tasks/{taskId}/logs`

## 📊 性能对比

### 前端直连
- ✅ 响应快（无网络延迟）
- ❌ API Key 暴露
- ❌ 无并发控制
- ❌ 无失败重试

### 后端 API
- ✅ API Key 安全
- ✅ 并发控制
- ✅ 自动重试
- ✅ 任务队列
- ⚠️ 轻微延迟（轮询）

## 🎯 下一步

完成迁移后，可以：
1. 移除前端的 `GEMINI_API_KEY` 配置
2. 继续迁移剩余功能
3. 优化轮询机制（使用 WebSocket）

---

**建议**: 先在开发环境测试，确认无误后再部署到生产环境。
