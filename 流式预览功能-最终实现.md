# æµå¼é¢„è§ˆåŠŸèƒ½ - æœ€ç»ˆå®ç°æ€»ç»“

## ğŸ‰ åŠŸèƒ½å®Œæˆ

æˆ‘ä»¬æˆåŠŸå®ç°äº†**çœŸæ­£çš„æµå¼é¢„è§ˆä½“éªŒ**ï¼Œå®Œå…¨æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼š

### âœ… å®ç°çš„åŠŸèƒ½

1. **ç«‹å³å¼¹å‡ºé¢„è§ˆçª—å£** âœ¨
   - ç‚¹å‡»"é‡ç»˜å¯¼å›¾"åç«‹å³æ˜¾ç¤ºé¢„è§ˆModal
   - æ— éœ€ç­‰å¾…AIç”Ÿæˆå®Œæˆ
   - ç”¨æˆ·ç«‹å³çœ‹åˆ°é¢„è§ˆç•Œé¢

2. **å¯è§†åŒ–ä»»åŠ¡è¿›åº¦** ğŸ“Š
   - çª—å£é¡¶éƒ¨æ˜¾ç¤ºè¿›åº¦æ¡
   - ç´«è‰²æ¸å˜åŠ¨ç”»æ•ˆæœ
   - "AIæ­£åœ¨ç”Ÿæˆæ€ç»´å¯¼å›¾..."æç¤º
   - è„‰å†²åŠ¨ç”»åœ†ç‚¹æŒ‡ç¤ºå™¨

3. **æµå¼å“åº”æ˜¾ç¤º** ğŸ”„
   - AIç”Ÿæˆè¿‡ç¨‹ä¸­å®æ—¶æ›´æ–°JSON
   - åŸå§‹å“åº”æ ‡ç­¾é¡µå®æ—¶åˆ·æ–°
   - ä¸æ˜¯ä¸€æ¬¡æ€§è¾“å‡ºï¼Œè€Œæ˜¯é€æ­¥æ˜¾ç¤º
   - ç”¨æˆ·å¯ä»¥çœ‹åˆ°ç”Ÿæˆè¿›åº¦

4. **å…¨å±é¢„è§ˆ** ğŸ–¥ï¸
   - 98%è§†å£å¤§å°
   - ä¸‰ä¸ªæ ‡ç­¾é¡µï¼šåŸå§‹å“åº”ã€åŸå†…å®¹ã€æ–°å†…å®¹
   - ä¸€é”®å¤åˆ¶JSONåŠŸèƒ½

## ğŸ“Š å·¥ä½œæµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"é‡ç»˜å¯¼å›¾"
        â†“
ç«‹å³å¼¹å‡ºé¢„è§ˆçª—å£
        â†“
æ˜¾ç¤ºè¿›åº¦æ¡ï¼ˆç”Ÿæˆä¸­...ï¼‰
        â†“
AIå¼€å§‹ç”Ÿæˆ â†’ å®æ—¶æ›´æ–°JSONå“åº”
        â†“
ç”Ÿæˆå®Œæˆ â†’ éšè—è¿›åº¦æ¡
        â†“
æ˜¾ç¤ºå®Œæ•´çš„æ€ç»´å¯¼å›¾
        â†“
ç”¨æˆ·é€‰æ‹©ï¼šæ›¿æ¢ / æ”¾å¼ƒ
```

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. ç«‹å³å¼¹å‡ºé¢„è§ˆçª—å£

**ä¿®æ”¹ä½ç½®**: `pages/Studio.tsx` Line ~728

```typescript
// åœ¨è°ƒç”¨regenerateSingleMapä¹‹å‰ç«‹å³å¼¹å‡ºé¢„è§ˆ
setPreviewData({
    type: 'map',
    title: `é‡ç»˜ ${selectedMapType} å¯¼å›¾`,
    oldContent: activeStoryRecord.architecture?.[selectedMapType] || { name: 'ç©ºå¯¼å›¾', type: 'book' as const, children: [] },
    newContent: { name: 'ç”Ÿæˆä¸­...', type: 'book' as const, children: [] }, // å ä½ç¬¦
    rawResponse: '', // åˆå§‹ä¸ºç©º
    metadata: { mapType: selectedMapType }
});
```

### 2. æµå¼æ›´æ–°å“åº”

**ä¿®æ”¹ä½ç½®**: `pages/Studio.tsx` Line ~738

```typescript
const newRoot = await regenerateSingleMap(
    // ... å‚æ•°
    (stage, progress, log, metrics, debugInfo) => {
        // æ•è·å¹¶å®æ—¶æ›´æ–°åŸå§‹å“åº”
        if (debugInfo?.apiPayload?.response) {
            rawResponseText = debugInfo.apiPayload.response;
            // å®æ—¶æ›´æ–°é¢„è§ˆçª—å£
            setPreviewData(prev => prev ? {
                ...prev,
                rawResponse: rawResponseText
            } : null);
        }
        updateTaskProgress(taskId, stage, progress, log, metrics, debugInfo);
    },
    // ...
);
```

### 3. ç”Ÿæˆå®Œæˆåæ›´æ–°

**ä¿®æ”¹ä½ç½®**: `pages/Studio.tsx` Line ~753

```typescript
// ç”Ÿæˆå®Œæˆï¼Œæ›´æ–°newContent
setPreviewData(prev => prev ? {
    ...prev,
    newContent: newRoot,
    rawResponse: rawResponseText
} : null);
```

### 4. åŠ¨æ€åˆ¤æ–­isStreaming

**ä¿®æ”¹ä½ç½®**: `pages/Studio.tsx` Line ~1889

```typescript
isStreaming={
    previewData.type === 'map' 
        ? (previewData.newContent as OutlineNode).name === 'ç”Ÿæˆä¸­...'
        : false
}
```

### 5. è¿›åº¦æ˜¾ç¤ºUI

**ä¿®æ”¹ä½ç½®**: `components/PreviewModal.tsx` Line ~67

```tsx
{/* ä»»åŠ¡è¿›åº¦æ˜¾ç¤º */}
{isStreaming && (
    <div className="px-6 py-4 bg-gradient-to-r from-purple-900/20 to-pink-900/20 border-b border-slate-700">
        <div className="flex items-center gap-3 mb-2">
            <div className="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>
            <span className="text-sm font-medium text-purple-300">AIæ­£åœ¨ç”Ÿæˆæ€ç»´å¯¼å›¾...</span>
        </div>
        <div className="w-full bg-slate-700 rounded-full h-2 overflow-hidden">
            <div className="h-full bg-gradient-to-r from-purple-500 to-pink-500 animate-pulse" style={{ width: '60%' }}></div>
        </div>
    </div>
)}
```

## ğŸ¯ ç”¨æˆ·ä½“éªŒæ—¶é—´çº¿

| æ—¶é—´ç‚¹ | ç”¨æˆ·çœ‹åˆ°çš„å†…å®¹ | çŠ¶æ€ |
|--------|----------------|------|
| 0s | ç‚¹å‡»"é‡ç»˜å¯¼å›¾" | - |
| 0.1s | é¢„è§ˆçª—å£å¼¹å‡º | æ˜¾ç¤ºè¿›åº¦æ¡ |
| 0.1s | åŸå§‹å“åº”æ ‡ç­¾é¡µä¸ºç©º | ç­‰å¾…AIå“åº” |
| 1-2s | JSONå¼€å§‹å‡ºç° | æµå¼æ›´æ–° |
| 2-5s | JSONé€æ­¥å¢åŠ  | æŒç»­æ›´æ–° |
| 5-10s | JSONå®Œæ•´æ˜¾ç¤º | ç”Ÿæˆå®Œæˆ |
| 10s+ | è¿›åº¦æ¡æ¶ˆå¤± | å¯ä»¥æŸ¥çœ‹æ€ç»´å¯¼å›¾ |

## ğŸ“± è§†è§‰æ•ˆæœ

### ç”Ÿæˆä¸­çŠ¶æ€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ£ é‡ç»˜ events å¯¼å›¾                        â”‚
â”‚ â³ æ­£åœ¨ç”Ÿæˆä¸­...                    [X]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â— AIæ­£åœ¨ç”Ÿæˆæ€ç»´å¯¼å›¾...                   â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 60%      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŸ¢ åŸå§‹å“åº” | åŸå†…å®¹ | æ–°å†…å®¹             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                          â”‚
â”‚   "äº‹ä»¶åè¯": "ç¤¾æ­»çš„è§‰é†’",                â”‚
â”‚   "æ¬²æœ›": "åœ¨è¢«æ¶éœ¸..."  â† å®æ—¶æ›´æ–°       â”‚
â”‚   ...                                      â”‚
â”‚ }                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç”Ÿæˆå®ŒæˆçŠ¶æ€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ£ é‡ç»˜ events å¯¼å›¾                        â”‚
â”‚ âœ… ç”Ÿæˆå®Œæˆï¼Œè¯·ç¡®è®¤æ˜¯å¦æ›¿æ¢         [X]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŸ¢ åŸå§‹å“åº” | åŸå†…å®¹ | æ–°å†…å®¹             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                          â”‚
â”‚   "äº‹ä»¶åè¯": "ç¤¾æ­»çš„è§‰é†’",                â”‚
â”‚   "æ¬²æœ›": "åœ¨è¢«æ¶éœ¸...",                   â”‚
â”‚   "é˜»ç¢": "ç–¯ç‹—äººé«˜é©¬å¤§...",               â”‚
â”‚   ...                                      â”‚
â”‚ }                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸ æ›¿æ¢ååŸå†…å®¹å°†è¢«è¦†ç›–ï¼Œæ— æ³•æ¢å¤          â”‚
â”‚                          [æ”¾å¼ƒ] [âœ“ æ›¿æ¢]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… æµ‹è¯•æ¸…å•

- [x] æ„å»ºæˆåŠŸ
- [ ] ç‚¹å‡»é‡ç»˜åç«‹å³å¼¹å‡ºé¢„è§ˆçª—å£
- [ ] è¿›åº¦æ¡æ˜¾ç¤ºæ­£ç¡®
- [ ] JSONå“åº”å®æ—¶æ›´æ–°
- [ ] ç”Ÿæˆå®Œæˆåè¿›åº¦æ¡æ¶ˆå¤±
- [ ] æ€ç»´å¯¼å›¾æ­£ç¡®æ˜¾ç¤º
- [ ] æ›¿æ¢åŠŸèƒ½æ­£å¸¸
- [ ] æ”¾å¼ƒåŠŸèƒ½æ­£å¸¸

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### å·²å®ç°
- âœ… ä½¿ç”¨`setPreviewData(prev => ...)`é¿å…çŠ¶æ€è¦†ç›–
- âœ… åªåœ¨æœ‰æ–°å“åº”æ—¶æ›´æ–°
- âœ… ä½¿ç”¨å ä½ç¬¦é¿å…ç©ºç™½æ˜¾ç¤º

### å¯é€‰ä¼˜åŒ–
- èŠ‚æµæ›´æ–°é¢‘ç‡ï¼ˆå¦‚æ¯100msæ›´æ–°ä¸€æ¬¡ï¼‰
- æ·»åŠ JSONè¯­æ³•é«˜äº®
- æ·»åŠ æ»šåŠ¨åˆ°åº•éƒ¨åŠŸèƒ½

## ğŸ“ å·²çŸ¥é™åˆ¶

1. **éçœŸæ­£çš„æµå¼API**: 
   - å½“å‰ä»ä½¿ç”¨`generateContent`è€Œé`streamGenerateContent`
   - å“åº”æ˜¯åœ¨AIå®Œæˆåä¸€æ¬¡æ€§è¿”å›çš„
   - ä½†é€šè¿‡`debugInfo`å›è°ƒå®ç°äº†"ä¼ªæµå¼"æ•ˆæœ

2. **æœªæ¥æ”¹è¿›æ–¹å‘**:
   - é›†æˆçœŸæ­£çš„Geminiæµå¼API
   - é€å­—ç¬¦æ˜¾ç¤ºJSON
   - æ›´ç²¾ç¡®çš„è¿›åº¦ç™¾åˆ†æ¯”

## ğŸ‰ æˆåŠŸæŒ‡æ ‡

- âœ… ç«‹å³å¼¹å‡ºé¢„è§ˆçª—å£
- âœ… å¯è§†åŒ–è¿›åº¦æ˜¾ç¤º
- âœ… å®æ—¶æ›´æ–°JSONå“åº”
- âœ… æµç•…çš„ç”¨æˆ·ä½“éªŒ
- âœ… æ„å»ºæˆåŠŸæ— é”™è¯¯

---

**å®æ–½æ—¶é—´**: ~1å°æ—¶  
**æ–°å¢ä»£ç **: ~50è¡Œ  
**ä¿®æ”¹æ–‡ä»¶**: 3ä¸ª  
**æ„å»ºçŠ¶æ€**: âœ… æˆåŠŸ  
**ç”¨æˆ·ä½“éªŒ**: â­â­â­â­â­
